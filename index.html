<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Hex General Evolved - Modular</title>
    <link rel="stylesheet" href="style.css">
    <link rel="manifest" href="manifest.json">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover, maximum-scale=1.0, minimum-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <script>
    // Service Worker DESACTIVADO TEMPORALMENTE para evitar loops de recarga
    // TODO: Reactivar cuando se solucione el problema de recargas infinitas
    
    console.log('‚ö†Ô∏è  Service Worker desactivado en esta versi√≥n');
    
    // Si hay SW activo, desregistrarlo
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.getRegistrations().then(registrations => {
            registrations.forEach(registration => {
                registration.unregister();
                console.log('üóëÔ∏è  Service Worker desregistrado');
            });
        });
    }
    
    /* DESACTIVADO - Causaba recargas infinitas
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('./sw.js?v=' + Date.now())
        .then(registration => {
            console.log("‚úÖ Iberion Service Worker registrado");
            
            // Verificar actualizaciones cada 5 segundos durante los primeros 30 seg
            let checkCount = 0;
            const checkInterval = setInterval(() => {
                registration.update();
                checkCount++;
                if (checkCount > 6) clearInterval(checkInterval);
            }, 5000);
            
            // Detectar nueva versi√≥n del SW
            registration.addEventListener('updatefound', () => {
                const newWorker = registration.installing;
                newWorker.addEventListener('statechange', () => {
                    if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                        console.log('üîÑ Nueva versi√≥n disponible, recargando...');
                        // Forzar activaci√≥n del nuevo SW
                        newWorker.postMessage('SKIP_WAITING');
                        // Recargar p√°gina despu√©s de 500ms
                        setTimeout(() => window.location.reload(), 500);
                    }
                });
            });
        })
        .catch(err => console.error('‚ùå Error registrando SW:', err));
        
        // Recargar cuando el SW tome control
        navigator.serviceWorker.addEventListener('controllerchange', () => {
            console.log('üîÑ SW actualizado, recargando p√°gina...');
            window.location.reload();
        });
    }
    */
    </script>

    <!-- 1. Google AdSense for Games (H5) API -->
    <!-- Reemplaza el data-ad-client con tu ID real de Google -->
    <script async
        data-ad-client="ca-pub-XXXXXXXXXXXXXXXX"
        data-ad-frequency-hint="30s"
        src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"
        crossorigin="anonymous">
    </script>

    <!-- 2. Stripe.js (Para procesar pagos reales de forma segura) -->
    <script src="https://js.stripe.com/v3/"></script>

    <!-- EN EL BODY, ANTES DE TUS SCRIPTS -->
    <script>
        // Inicializaci√≥n temprana de la API de Google
        window.adsbygoogle = window.adsbygoogle || [];
        window.adConfig = function(o) { window.adsbygoogle.push(o); };
    </script>

</head>
<body>

    <!-- Puntos de Victoria-->
    <div id="victory-points-tracker" style="display: none;">
        <span class="vp-icon">üëë</span>
        <span id="victory-points-summary"></span>
        <div id="victory-points-tooltip" class="tooltip">
            <!-- El contenido se generar√° con JS -->
        </div>
    </div>

    <!-- ================================================== -->
    <!-- MODAL DE LA TESORER√çA (TIENDA) -->
    <!-- ================================================== -->

    <div id="storeModal" class="modal" style="display: none; z-index: 20000;">
        <div class="modal-content">
            <div class="store-header">
                <h2>Tesorer√≠a Real</h2>
                <div class="currency-display">
                    <div class="curr-item">üíé <span id="storeGemCount">0</span></div>
                    <div class="curr-item">üí∞ <span id="storeGoldCount">0</span></div>
                </div>
                <span class="close-button" onclick="StoreManager.close()">√ó</span>
            </div>
            <div id="storeGrid">
                <!-- JS Rellenar√° esto -->
            </div>
        </div>
    </div>

    <!-- ================================================== -->
    <!-- ===== NUEVO: CONTADOR DE TIEMPO POR TURNO ====== -->
    <!-- ================================================== -->
    <div id="turnTimerDisplay" class="turn-timer-display" style="display: none;">
        <span>‚è≥</span>
        <span id="turnTimerValue">00:00</span>
    </div>

    <!-- ====================================================================== -->
    <!-- ============ CONTENEDOR S√ìLO PARA CENTRAR EL JUEGO =================== -->
    <!-- ====================================================================== -->
    <main id="game-wrapper">
        <div class="game-container" style="display: none;"> 
            <div id="gameBoard"></div>
            <div id="turnBlocker" class="turn-blocker" style="display: none;">Esperando al Oponente...</div>
            <!-- LOS PANELES DE UI YA NO EST√ÅN AQU√ç DENTRO -->
            
        </div>
    </main>

    <!-- ====================================================================== -->
    <!-- ===== TODOS LOS ELEMENTOS DE UI (PANELES, MODALES, BOTONES) VAN AQU√ç ==== -->
    <!-- ==== SON HIJOS DIRECTOS DEL BODY PARA QUE "FLOTEN" CORRECTAMENTE ==== -->
    <!-- ====================================================================== -->

    <!-- PANELES FLOTANTES INFERIORES -->
    <div id="tutorialMessagePanel" class="tutorial-panel">
        <button id="closeTutorialPanelBtn">√ó</button>
        <span id="tutorialMessageText"></span>
    </div>

    <!-- ====================================================================== -->
    <!-- ===================== PANEL INFERIOR (REDISE√ëADO) ================== -->
    <!-- ====================================================================== -->
    <div id="contextualInfoPanel">
        <button id="closeContextualPanelBtn">√ó</button>
        <div id="contextual-line-1"></div> <!-- L√≠nea para la info de la unidad -->
        <div id="contextual-line-2"></div> <!-- L√≠nea para la info del hex√°gono -->
    </div>
    
    <button id="reopenContextualPanelBtn" style="display: none;">‚ñ≤</button>

    <!-- ====================================================================== -->
    <!-- MEN√ö FLOTANTE SUPERIOR IZQUIERDO -->
    <!-- ====================================================================== -->
    <div id="top-bar-menu" class="top-bar" style="display: none;"> <!-- Oculto inicialmente -->

    <!-- Panel de Informaci√≥n a la Izquierda (siempre visible cuando el men√∫ est√° abierto) -->
    <div id="top-bar-info" class="top-bar-panel">
        <div id="top-bar-phase-turn">Fase: - | Turno: - | Jugador: -</div>
        <div id="top-bar-resources">
            <div class="resource-item"><span>üí∞</span><strong data-resource="oro">0</strong></div>
            <div class="resource-item"><span>‚õìÔ∏è</span><strong data-resource="hierro">0</strong></div>
            <div class="resource-item"><span>üóø</span><strong data-resource="piedra">0</strong></div>
            <div class="resource-item"><span>üå≤</span><strong data-resource="madera">0</strong></div>
            <div class="resource-item"><span>üåæ</span><strong data-resource="comida">0</strong></div>
            <div class="resource-item"><span>üí°</span><strong data-resource="researchPoints">0</strong></div>
            <div class="resource-item"><span>üéñÔ∏è</span><strong data-resource="puntosReclutamiento">0</strong></div>
        </div>
    </div>

    <!-- Panel de Botones a la Derecha (oculto inicialmente, se expande) -->
    <div id="top-bar-actions" class="top-bar-panel top-bar-actions-panel">
        <button id="btn-open-ledger" title="Abrir Cuaderno de Estado" onclick="if(typeof LedgerManager !== 'undefined') { LedgerManager.open(); }">üìñ</button>
        
        <button id="saveGameBtn_top" title="Guardar Partida">üíæ</button>
        
        <label for="loadGameInput_top" class="button-like-label" title="Cargar Partida">üìÇ</label>
        <input type="file" id="loadGameInput_top" accept=".json" style="display: none;">
        
        <button id="exportProfileBtn_top" title="Exportar Mi Perfil">üë§</button>
        <button id="concedeBattleBtn_top" title="Rendirse / Salir">üè≥Ô∏è</button>
    </div>

</div>

    <!-- ====================================================================== -->
    <!-- ================ BARRA DE ACCIONES V2 (CON MEN√ö COLAPSABLE) ========= -->
    <!-- ====================================================================== -->
    <div id="tactical-ui-container" style="display: none;">
        
        <!-- Grupo Izquierdo: Acciones de Unidad (Contextuales) -->
        <div class="floating-action-group left">
            <button id="floatingUndoMoveBtn" title="Deshacer Movimiento">‚Ü©</button>
            <button id="floatingReinforceBtn" title="Gestionar/Reforzar">üí™</button>
            <button id="floatingSplitBtn" title="Dividir Unidad">‚úÇÔ∏è</button>
            <button id="floatingBuildBtn" title="Construir">üèóÔ∏è</button>
            <button id="floatingPillageBtn" title="Saquear">üí∞</button>
            <button id="floatingRazeBtn" title="Arrasar Estructura">üí£</button>
            <button id="floatingExploreRuinBtn" title="Explorar Ruinas">üß≠</button>
            <button id="floatingAssignGeneralBtn" title="Asignar General">üë§</button>
            <button id="floatingConsolidateBtn" title="Consolidar">üîÅ</button>
            <button id="floatingCreateDivisionBtn" title="Crear Divisi√≥n">‚ûï</button>
            <button id="setAsCapitalBtn" title="Establecer Capital">üëë</button>
            <button id="floatingTradeBtn" title="Iniciar Ruta Comercial">üöö</button>
            <button id="floatingStopTradeBtn" title="Detener Ruta Comercial">üõë</button>
        </div>

        <!-- === GRUPO DERECHO === -->
        <div class="floating-action-group right">
            
            <!-- CONTENEDOR DEL MEN√ö EXPANDIBLE ‚öôÔ∏è -->
            <div class="right-menu-group">
                <button id="toggle-right-menu-btn" class="menu-toggle-btn" title="Opciones Globales">‚öôÔ∏è</button>
                <div id="right-submenu" class="submenu">
                    <button id="barracksBtn" title="Cuartel">üéñÔ∏è</button>
                    <button id="openInventoryBtn" title="Bolsa de Objetos">üéí</button>
                    <button id="openForgeBtn" title="Forja">‚öîÔ∏è</button>
                    <button id="floatingWikiBtn" title="Wiki">‚ÑπÔ∏è</button>
                    <button id="floatingInboxBtn" title="Buz√≥n">‚úâÔ∏è</button>
                    <button id="floatingTechTreeBtn" title="Tecnolog√≠as">üí°</button>
                    <button id="floatingConsoleBtn" title="Consola">C</button>
                    <button id="floatingMenuBtn" title="Men√∫ Principal">‚ò∞</button>
                </div>
            </div>
            
            <!-- BOTONES FIJOS DE ACCI√ìN -->
            <button id="floatingNextUnitBtn" title="Siguiente Unidad">¬ª</button>
            <button id="floatingEndTurnBtn" title="Finalizar Turno">‚ñ∫</button>
        </div>

    </div>
    
    <!-- versi√≥n -->
<div class="version-watermark" id="version-display">V1.003</div>
<div class="name-watermark" id="name-watermark">U6</div>
    <!-- versi√≥n -->

    <!-- El resto de tus elementos como #combatPredictionPanel y los scripts van despu√©s -->
    <div id="combatPredictionPanel" style="display: none;"></div>
    <div id="debug-console" style="display: none;">
        <div id="console-output"></div>
        <input type="text" id="console-input" placeholder="Escribe un comando...">
    </div>  

    <!-- ====================================================================== -->
    <!-- ======================= MODAL DE CONFIGURACI√ìN ======================= -->
    <!-- ====================================================================== -->
    <div id="settingsModal" class="modal modal-themed" style="display: none; z-index: 10010;">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h2>Configuraci√≥n</h2>
                <span class="close-button" id="closeSettingsBtn">√ó</span>
            </div>
            
            <div class="modal-body" style="padding: 20px;">
                
                <!-- SECCI√ìN DE AUDIO -->
                <h4 style="color: #f1c40f; border-bottom: 1px solid #555; margin-bottom: 15px;">Audio</h4>
                
                <div class="setting-row" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <span>üéµ M√∫sica</span>
                    <label class="switch">
                        <input type="checkbox" id="settingMusicToggle" checked>
                        <span class="slider round"></span>
                    </label>
                </div>

                <div class="setting-row" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <span>üîä Efectos de Sonido</span>
                    <label class="switch">
                        <input type="checkbox" id="settingSfxToggle" checked>
                        <span class="slider round"></span>
                    </label>
                </div>

                <!-- SECCI√ìN DE JUEGO -->
                <h4 style="color: #f1c40f; border-bottom: 1px solid #555; margin-bottom: 15px; margin-top: 25px;">Juego</h4>

                <div class="setting-row" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <span>üí∞ Confirmar Gasto de Oro</span>
                    <label class="switch">
                        <input type="checkbox" id="settingGoldConfirm" checked>
                        <span class="slider round"></span>
                    </label>
                </div>

                <div class="setting-row" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <span>üí° Mostrar Pistas (Tutorial)</span>
                    <label class="switch">
                        <input type="checkbox" id="settingHints" checked>
                        <span class="slider round"></span>
                    </label>
                </div>

                <!-- Botones Extra -->
                <button id="resetHintsBtn" style="width:100%; padding:10px; margin-top:15px; background-color:#6c757d; border:none; border-radius:5px; color:white;">Reiniciar Avisos de Ayuda</button>

            </div>

            <div class="modal-footer">
                <button id="saveSettingsBtn" class="button-primary">Guardar Cambios</button>
            </div>
        </div>
    </div>

    <!-- ====================================================================== -->
    <!-- ======================== PANTALLA DE LOGIN ========================= -->
    <!-- ====================================================================== -->
    <div id="loginScreen" class="modal" style="display: none; text-align: center; align-items: center; justify-content: center; background-color: rgba(0,0,0,0.9); z-index: 2000; position: fixed; top: 0; left: 0; width: 100%; height: 100%">
        <div class="modal-content" style="width: auto; min-width: 320px; max-width: 400px; padding: 40px 30px; border: 2px solid #ffd700; background: #1a1a1a; color: white;">
            
            <h1 style="color: #f1c40f; margin-bottom: 30px; letter-spacing: 2px; font-size: 2em;">IBERION</h1>

            <!-- OPCI√ìN 1: JUGADOR NUEVO -->
            <button id="newPlayerDirectBtn" style="width:100%; padding:15px; margin-bottom: 25px; background: linear-gradient(180deg, #2ecc71, #27ae60); color:white; font-size:1.1em; font-weight:bold; border:none; border-radius:8px; cursor:pointer; box-shadow: 0 4px 0 #219150;">
                ‚öîÔ∏è JUGADOR NUEVO
            </button>

            <p style="margin:20px 0; color:#888; font-size:0.9em;">‚Äî O INICIA SESI√ìN ‚Äî</p>

            <!-- OPCI√ìN 2: GOOGLE (Tu c√≥digo) -->
            <button id="googleLoginBtn" style="padding: 12px 20px; background-color: #fff; color: #757575; border: none; border-radius: 5px; cursor: pointer; display: flex; align-items: center; justify-content: center; width: 100%; font-weight: 500; font-family: Roboto, sans-serif; margin-bottom: 15px;">
                <svg style="width:20px; margin-right:10px" viewBox="0 0 24 24">
                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l3.66-2.84z"/>
                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.66l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                Entrar con Google
            </button>

            <!-- OPCI√ìN 3: FACEBOOK (A√±adido) -->
            <button id="facebookLoginBtn" style="padding: 12px 20px; background-color: #1877f2; color: #fff; border: none; border-radius: 5px; cursor: pointer; display: flex; align-items: center; justify-content: center; width: 100%; font-weight: 500; font-family: Roboto, sans-serif;">
                <svg style="width:20px; margin-right:10px" viewBox="0 0 24 24">
                    <path fill="#ffffff" d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.791-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
                </svg>
                Entrar con Facebook
            </button>
            
        </div>
    </div>

    <!-- ====================================================================== -->
    <!-- ===================== MODAL DE BIENVENIDA Y AYUDA ==================== -->
    <!-- ====================================================================== -->
    <div id="welcomeHelpModal" class="modal" style="display: none;">
        <div class="modal-content help-modal-content">
            <span class="close-button" id="closeWelcomeHelpBtn" title="Cerrar">√ó</span>
            <h2 id="welcomeHelpTitle" style="text-align: center; color: #333; margin-bottom: 20px;"></h2>
            <div id="welcomeHelpSections">
                <!-- Las secciones de ayuda se a√±adir√°n aqu√≠ por JS -->
            </div>
            <p id="welcomeHelpFooter" style="text-align: center; margin-top: 25px; font-style: italic; color: #555;"></p>
            <div style="text-align: center; margin-top: 20px;">
                <label for="doNotShowAgainCheckbox" style="font-size: 0.9em; color: #666; cursor: pointer;">
                    <input type="checkbox" id="doNotShowAgainCheckbox" style="margin-right: 5px;">
                    No mostrar de nuevo al iniciar
                </label>
                <button id="startGameFromHelpBtn" style="margin-top: 15px; padding: 10px 20px; font-size: 1.1em;">Empezar Juego</button>
            </div>
        </div>
    </div>

    <!-- ====================================================================== -->
    <!-- ===================== Aviso Legal                   ==================== -->
    <!-- ====================================================================== -->    
    <div id="legalModal" class="modal modal-overlay" style="display: none; z-index: 11000;">
        <div class="modal-content" style="text-align:center;">
            <h3>T√©rminos y Privacidad</h3>
            <p style="font-size:0.9em">Este juego utiliza cookies para guardar tu progreso y requiere aceptar nuestras condiciones de uso.</p>
            <div style="margin-top:20px; display:flex; justify-content:center; gap:10px;">
                <button onclick="window.open('URL_TUS_CONDICIONES', '_blank')" class="button-secondary">Leer</button>
                <button id="acceptLegalBtn" class="button-primary">ACEPTAR Y JUGAR</button>
            </div>
        </div>
    </div>



    <!-- ====================================================================== -->
    <!-- ===================== PANTALLA DE MEN√ö PRINCIPAL ===================== -->
    <!-- ====================================================================== -->

    <div id="mainMenuScreen" class="modal no-close-on-click" style="display: flex; z-index: 100; position: fixed; width: 100%; height: 100%; top: 0; left: 0; overflow: hidden;">
    <!-- Contenedor para los "Hotspots" o botones invisibles -->
        <div id="interactiveBoardContainer">
        <!-- Partida R√°pida: Tablero hexagonal central -->
            <div id="hotspotMap" class="main-menu-hotspot" data-action="openGameModes"></div>
        <!-- Cuartel: Libro arriba a la izquierda -->
            <div id="hotspotBarracks" class="main-menu-hotspot" data-action="openBarracks"></div>
        <!-- Forja: Soldados a la izquierda -->
            <div id="hotspotForge" class="main-menu-hotspot" data-action="openForge"></div>
        <!-- Altar de los Deseos: Estatua a la derecha -->
            <div id="hotspotAltar" class="main-menu-hotspot" data-action="openAltar"></div>
        <!-- Campa√±a: Edificio grande arriba -->
            <div id="hotspotCampaign" class="main-menu-hotspot" data-action="openProfile"></div>
        <!-- NUEVO HOTSPOT: ALIANZA (Abajo a la derecha) -->
        <!--<div id="hotspotAlliance" class="main-menu-hotspot" data-action="openAlliance"></div>-->
        <!-- Tronos de Iberia: Ruinas a la derecha -->
        <div id="hotspotThrones" class="main-menu-hotspot" data-action="openAlliance"></div>
        <!-- Tienda: Cofre a la derecha abajo -->
        <div id="hotspotStore" class="main-menu-hotspot" data-action="openStore" 
            style="top: 70%; left: 80%; width: 15%; height: 20%;">
        </div>
        
        <!-- Informaci√≥n del General y Logout -->
            <div id="generalInfoPanel">
                <span>General: <strong id="currentGeneralName_main">Ninguno</strong></span>
                <button id="logoutBtn_main" title="Cerrar Sesi√≥n">‚èª</button>
            </div>
        </div>

    <!-- Modal SECUNDARIO para los modos de juego -->
        <div id="gameModesModal" class="modal" style="display: none; background-color: rgba(0,0,0,0.7);">
            <div class="modal-content" style="text-align: center; max-width: 400px;">
                <span class="close-button" id="closeGameModesModalBtn">√ó</span>
                <h2>Elige tu Batalla</h2>
                <button id="resumeGameBtn" style="display: block; width: 90%; margin: 20px auto; padding: 15px; font-size: 1.1em; background-color: #2980b9; color: white; font-weight:bold; border: 2px solid #3498db; box-shadow: 0 0 10px rgba(41, 128, 185, 0.5);"> ‚ñ∂Ô∏è Cargar Partida</button>
                <button id="startSkirmishBtn_new" style="display: block; width: 90%; margin: 20px auto; padding: 15px; font-size: 1.1em;">Partida R√°pida (Escaramuza)</button>
                <button id="startTutorialBtn_new" style="display: block; width: 90%; margin: 20px auto; padding: 15px; font-size: 1.1em; background-color: #28a745;">Iniciar Tutorial (5 min)</button>
                <button id="joinNetworkGameBtn_new" style="display: block; width: 90%; margin: 20px auto; padding: 15px; font-size: 1.1em; background-color: #ffc107; color: black;">Unirse a Partida en Red</button>
            </div>
        </div>
    </div>

    <!-- ====================================================================== -->
    <!-- ====== Modal del perfil del jugador                             ====== -->
    <!-- ====================================================================== -->

    <div id="profileModal" class="modal modal-themed" style="display: none; z-index: 10000;">
        <div class="modal-content" style="max-width: 600px; width: 95vw; height: 350px; padding: 0; background: #2c2219; border: 2px solid #ffd700; overflow: hidden; display: flex; flex-direction: column;">
            
            <!-- 1. HEADER: Identidad, Pase de Batalla y Reclamo -->
            <div style="height: 85px; background: linear-gradient(to right, #4e342e, #2c2219); display: flex; align-items: center; padding: 0 10px; position: relative; border-bottom: 1px solid #5d4037; flex-shrink: 0;">
                
                <!-- A. Avatar -->
                <div id="profileAvatar" onclick="changeAvatar()" style="width: 55px; height: 55px; border: 2px solid gold; border-radius: 10px; font-size: 2.2em; display: flex; align-items: center; justify-content: center; background: #111; cursor:pointer; flex-shrink: 0;">üéñÔ∏è</div>
                
                <!-- B. Info Jugador (Nombre + Nivel + Barra) -->
                <div style="margin-left: 10px; min-width: 100px;">
                    <h2 id="profileUsername" style="margin: 0; font-size: 1em; color: white; white-space: nowrap;">General</h2>
                    <div style="font-size: 0.7em; color: #f1c40f;">Lvl <span id="profileLevelNum">1</span> | <span id="allianceName">Sin Alianza</span></div>
                    <!-- Barra XP mini -->
                    <div style="width: 100%; max-width: 100px; height: 5px; background: #000; border-radius: 3px; margin-top: 5px;">
                        <div id="profileXpBar" style="width: 0%; height: 100%; background: #4caf50;"></div>
                    </div>
                </div>

                <!-- C. NUEVO BOT√ìN: PASE DE BATALLA (Centro Flexible) -->
                <div style="flex-grow: 1; display: flex; justify-content: center; padding-right: 55px;"> <!-- padding-right para compensar el bot√≥n de reclamo absoluto -->
                    <button id="openBattlePassProfileBtn" style="
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                        border: 1px solid #a4b0be; 
                        border-radius: 5px; 
                        color: white; 
                        padding: 4px 8px; 
                        cursor: pointer; 
                        box-shadow: 0 0 5px rgba(0,0,0,0.5);
                        display: flex; flex-direction: column; align-items: center; line-height: 1.1;
                    ">
                        <span style="font-size: 0.6em; color: #ffd700; font-weight:bold;">TEMPORADA 1</span>
                        <span style="font-size: 0.85em; font-weight: bold;">üé´ PASE</span>
                    </button>
                </div>

                <!-- D. Bot√≥n Reclamar (Posici√≥n Absoluta Derecha) -->
                <button id="claimDailyBtn" style="position: absolute; right: 10px; bottom: 10px; padding: 4px 8px; font-size: 9px; background: #f1c40f; border: none; border-radius: 4px; font-weight: bold; width: 65px; z-index: 5;">RECLAMAR üéÅ</button>
                
                <!-- E. Bot√≥n Cerrar (Posici√≥n Absoluta Arriba) -->
                <span class="close-button" id="closeProfileBtn" style="position: absolute; top: 5px; right: 8px; font-size: 24px; color: #ccc; cursor: pointer; z-index: 6;">√ó</span>
            </div>

            <!-- 2. NAV ICONS (Tus botones originales) -->
            <div style="height: 40px; background: #3e2723; display: flex; justify-content: space-around; align-items: center; border-bottom: 1px solid #5d4037; flex-shrink: 0;">
                <span onclick="openLandingPage(true)" title="Informaci√≥n del Juego" style="font-size: 20px; cursor:pointer; padding: 5px;">‚ÑπÔ∏è</span>
                <span onclick="openRankingModal()" title="Ranking" style="font-size: 20px; cursor:pointer; padding: 5px;">üèÜ</span>
                <span onclick="document.getElementById('barracksModal').style.display='flex'" title="Cuartel" style="font-size: 20px; cursor:pointer; padding: 5px;">üéñÔ∏è</span>
                <span onclick="openSettingsModal()" title="Configuraci√≥n" style="font-size: 20px; cursor:pointer; padding: 5px;">‚öôÔ∏è</span>
            </div>

            <!-- 3. GRID DE ESTAD√çSTICAS (Tus stats originales) -->
            <div style="padding: 10px; display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; overflow-y: auto;">
                <div class="stat-box" style="padding: 5px; text-align: center; border-radius: 5px; background: rgba(0,0,0,0.3); border: 1px solid #5d4037;">
                    <span style="font-size: 8px; display: block; color: #bcaaa4;">VICTORIAS</span>
                    <strong id="statWins" style="font-size: 11px; color: #fff;">0</strong>
                </div>
                <div class="stat-box" style="padding: 5px; text-align: center; border-radius: 5px; background: rgba(0,0,0,0.3); border: 1px solid #5d4037;">
                    <span style="font-size: 8px; display: block; color: #bcaaa4;">BAJAS</span>
                    <strong id="statKills" style="font-size: 11px; color: #ff5252;">0</strong>
                </div>
                <div class="stat-box" style="padding: 5px; text-align: center; border-radius: 5px; background: rgba(0,0,0,0.3); border: 1px solid #5d4037;">
                    <span style="font-size: 8px; display: block; color: #bcaaa4;">TROPAS</span>
                    <strong id="statTroops" style="font-size: 11px; color: #4caf50;">0</strong>
                </div>
                <div class="stat-box" style="padding: 5px; text-align: center; border-radius: 5px; background: rgba(0,0,0,0.3); border: 1px solid #5d4037;">
                    <span style="font-size: 8px; display: block; color: #bcaaa4;">COMERCIO</span>
                    <strong id="statTrades" style="font-size: 11px; color: #ffeb3b;">0</strong>
                </div>
                <div class="stat-box" style="padding: 5px; text-align: center; border-radius: 5px; background: rgba(0,0,0,0.3); border: 1px solid #5d4037;">
                    <span style="font-size: 8px; display: block; color: #bcaaa4;">CIUDADES</span>
                    <strong id="statCities" style="font-size: 11px; color: #00f3ff;">0</strong>
                </div>
            </div>

            <!-- 4. FOOTER: Bot√≥n del C√≥dice -->
            <div style="padding: 10px; margin-top: auto; border-top: 1px solid #5d4037; text-align: center;">
                <button onclick="openFullCodex()" style="width: 100%; padding: 8px; background: #1b130c; color: #ffd700; border: 1px solid #ffd700; border-radius: 5px; font-size: 11px; font-weight: bold; cursor: pointer;">üìñ ABRIR C√ìDICE DE BATALLAS</button>
            </div>
        </div>
    </div>

    <!-- ====================================================================== -->
    <!-- ======================= MODAL DE CLASIFICACI√ìN ======================= -->
    <!-- ====================================================================== -->
    <div id="rankingModal" class="modal modal-themed" style="display: none; z-index: 10008;">
        <div class="modal-content" style="max-width: 500px; height: 80vh;">
            
            <div class="modal-header">
                <h2>Tabla de L√≠deres</h2>
                <span class="close-button" id="closeRankingBtn">√ó</span>
            </div>

            <!-- Pesta√±as para filtrar -->
            <div class="ranking-tabs">
                <button class="ranking-tab-btn active" data-metric="xp">‚≠ê Experiencia</button>
                <button class="ranking-tab-btn" data-metric="wins">üèÜ Victorias</button>
            </div>
            
            <!-- Cabecera de la lista -->
            <div class="ranking-header-row">
                <span class="rnk-num">#</span>
                <span class="rnk-name">General</span>
                <span class="rnk-val">Valor</span>
            </div>

            <!-- Cuerpo con Scroll -->
            <div class="modal-body" id="rankingListContainer" style="padding: 0; background: rgba(0,0,0,0.2);">
                <p style="text-align: center; color: #888; margin-top: 20px;">Cargando datos globales...</p>
            </div>

            <!-- Fila fija para MI usuario (siempre visible) -->
            <div id="myRankingRow" class="ranking-footer-row">
                <span class="rnk-num">?</span>
                <span class="rnk-name">T√∫</span>
                <span class="rnk-val">-</span>
            </div>

        </div>
    </div>

    <!-- ====================================================================== -->
    <!-- ====================== MODAL DE PASE DE BATALLA ====================== -->
    <!-- ====================================================================== -->
    
    <div id="battlePassModal" class="modal modal-themed" style="display: none; z-index: 10020;">
        <div class="modal-content bp-main-container">
            
            <!-- CABECERA (Funcional y Compacta) -->
            <div class="bp-header-hero">
                <!-- Bloque Izquierdo: Info -->
                <div class="bp-header-col info">
                    <h2 id="bpSeasonName">CARGANDO...</h2>
                    <div id="bpSeasonTimer" style="color:#ffd700; font-family:monospace;">--d --h</div>
                </div>

                <!-- Bloque Centro: Barra XP -->
                <div class="bp-header-col progress">
                    <div style="display:flex; justify-content:center; gap:10px; width:100%; font-weight:bold; font-size:0.9em;">
                        <span id="bpLvlLeft">1</span>
                        <span id="bpXpText" style="color:#aaa;">0 / 0</span>
                        <span id="bpLvlRight">2</span>
                    </div>
                    <!-- Barra de Progreso Visual -->
                    <div class="bp-xp-track-header">
                        <div id="bpHeaderProgressBar"></div>
                    </div>
                </div>

                <!-- Bloque Derecha: Acciones -->
                <div class="bp-header-col actions">
                    <button id="buyPremiumBtn" class="bp-gold-cta">
                        ACTIVAR DORADO
                    </button>
                    <button id="closeBattlePassBtn" class="bp-close-x">√ó</button>
                </div>
            </div>

            <!-- CUERPO INFERIOR: El Dise√±o "Camino" Restaurado -->
            <div class="bp-scroll-wrapper">
                <!-- Etiquetas Flotantes (Izquierda) -->
                <div class="bp-track-labels">
                    <div class="label-track gold">Pase<br>Dorado</div>
                    <div class="label-track free">Gratis</div>
                </div>

                <!-- Contenedor del Scroll -->
                <div id="bpScrollContainer" class="bp-items-track">
                    <!-- El JS rellenar√° esto con cajas bonitas -->
                </div>
            </div>

        </div>
    </div>
    
    <!-- ====================================================================== -->
    <!-- ====== Modal del c√≥dice                                         ====== -->
    <!-- ====================================================================== -->

    <!-- Modal del C√≥dice Completo (Necesario para que el JS encuentre 'fullCodexList') -->
    <div id="fullCodexModal" class="modal modal-themed" style="display: none; background: rgba(0,0,0,0.9); z-index: 10001;">
        <div class="modal-content" style="max-width: 500px; width: 90vw; height: 80vh; background: #1b130c; border: 2px solid #ffd700; display: flex; flex-direction: column; padding: 0;">
            <header style="padding: 15px; border-bottom: 2px solid #5d4037; display: flex; justify-content: space-between; align-items: center;">
                <h2 style="margin: 0; color: #ffd700; font-size: 1.1em;">üìö CR√ìNICAS HIST√ìRICAS</h2>
                <span class="close-button" onclick="document.getElementById('fullCodexModal').style.display='none'" style="cursor:pointer; font-size:24px;">√ó</span>
            </header>
            <!-- ESTE ES EL ELEMENTO QUE BUSCA EL JS (id="fullCodexList") -->
            <div id="fullCodexList" style="flex-grow: 1; overflow-y: auto; padding: 15px; background: rgba(0,0,0,0.2);">
                <!-- Aqu√≠ se cargar√°n las batallas -->
            </div>
            <footer style="padding: 10px; text-align: center; border-top: 1px solid #5d4037;">
                <button onclick="document.getElementById('fullCodexModal').style.display='none'" style="padding: 10px 20px; background: #4e342e; color: #fff; border: 1px solid #8d6e63; border-radius: 5px; cursor: pointer;">VOLVER AL PERFIL</button>
            </footer>
        </div>
    </div>

    <!-- ====================================================================== -->
    <!-- ====== MODAL DE MIS PARTIDAS Carga de Partidas                  ====== -->
    <!-- ====================================================================== -->

    <div id="myGamesModal" class="modal modal-themed" style="display: none; z-index: 10080; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); justify-content: center; align-items: center;">
        <div class="modal-content" style="max-width: 700px; height: 90vh; padding: 0; display: flex; flex-direction: column;">
            
            <!-- CABECERA -->
            <div class="modal-header" style="flex-shrink: 0;">
                <h2 style="margin:0; font-size:1.2em; color:#f1c40f;">CARGAR PARTIDA</h2> <!-- T√≠tulo corregido -->
                <span class="close-button" id="closeMyGamesBtn">√ó</span>
            </div>
            
            <!-- PESTA√ëAS DE NAVEGACI√ìN -->
            <div class="ranking-tabs" style="flex-shrink: 0; border-bottom: 1px solid #444;">
                <button class="ranking-tab-btn active" id="tabMyGames" onclick="switchGamesTab('my')">MIS PARTIDAS</button>
                <button class="ranking-tab-btn" id="tabPublicGames" onclick="switchGamesTab('public')">üåç MERCADO DE GUERRA</button>
            </div>

            <!-- CUERPO: MIS PARTIDAS (Lista Vertical) -->
            <div id="myGamesListPanel" class="games-panel active" style="flex-grow: 1; overflow-y: auto; padding: 10px; background: rgba(0,0,0,0.2);">
                <!-- Aqu√≠ se inyectan las tarjetas de TUS partidas -->
                <p style="text-align:center; color:#888; margin-top:20px;">Cargando operaciones...</p>
            </div>

            <!-- CUERPO: MERCADO P√öBLICO (Filtros + Lista) -->
            <div id="publicGamesListPanel" class="games-panel" style="display: none; flex-grow: 1; overflow-y: auto; padding: 10px; background: rgba(0,0,0,0.2);">
                
                <!-- Filtros de B√∫squeda -->
                <div class="public-filters" style="display: flex; gap: 10px; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #444;">
                    <select id="filterTurnLimit" style="background:#333; color:#fff; border:1px solid #555; padding:5px;">
                        <option value="any">Cualquier Turno</option>
                        <option value="early">Inicio (< 10)</option>
                        <option value="mid">Media (10-30)</option>
                        <option value="late">Final (> 30)</option>
                    </select>
                    <button onclick="refreshPublicGames()" style="background:#2980b9; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;">üîÑ Actualizar</button>
                </div>

                <!-- Lista de Partidas Abandonadas/P√∫blicas -->
                <div id="publicGamesList">
                    <!-- Se rellena con JS -->
                </div>
            </div>

        </div>
    </div>

    <!-- MEN√ö FLOTANTE DE OPCIONES (Para el Long-Press o bot√≥n de 3 puntos) -->
    <div id="matchContextMenu" style="display: none; position: fixed; background: #2c3e50; border: 1px solid #f1c40f; border-radius: 5px; z-index: 10090; box-shadow: 0 4px 15px rgba(0,0,0,0.8); min-width: 150px;">
        <button class="ctx-btn" id="ctxAbandon">‚ùå Abandonar</button>
        <button class="ctx-btn" id="ctxConvertToAI">ü§ñ Pasar a IA</button>
        <button class="ctx-btn" id="ctxShare">üîó Invitar Amigo</button>
        <button class="ctx-btn cancel" onclick="this.parentElement.style.display='none'">Cancelar</button>
    </div>

    <!-- ====================================================================== -->
    <!-- ====== PANTALLA DE CONFIGURACI√ìN DE PARTIDA R√ÅPIDA (ESCARAMUZA) ====== -->
    <!-- ====================================================================== -->

    <div id="setupScreen" class="modal-overlay">
        <div class="modal-container">
            <header class="modal-header">
                <h2>Configuraci√≥n de Partida</h2>
                <button class="modal-close-btn" data-target="mainMenuScreenEl">√ó</button>
            </header>
            <main class="modal-body setup-screen-themed">
                <div class="setup-grid">
                    <!-- Columna Izquierda: Mapa -->
                    <div class="setup-column">
                        <h4>MAPA</h4>
                        <div class="setup-option">
                            <label for="boardSizeSelect">Tama√±o</label>
                            <select id="boardSizeSelect">
                                <option value="small" selected>Peque√±o</option>
                                <option value="medium">Mediano</option>
                                <option value="large">Grande</option>
                            </select>
                        </div>
                        <div class="setup-option">
                            <label for="resourceLevel">Recursos</label>
                            <select id="resourceLevel">
                                <option value="min" selected>M√≠nimos</option>
                                <option value="med">Medios</option>
                                <option value="max">Muchos</option>
                            </select>
                        </div>
                        <!-- Opci√≥n de Mapa Naval (solo visible en mapas grandes) -->
                        <div class="setup-option" id="navalMapOption" style="display: none;">
                            <label for="navalMapCheckbox">
                                <input type="checkbox" id="navalMapCheckbox" style="width: auto; margin-right: 5px;">
                                Mapa Naval (Archipi√©lagos)
                            </label>
                        </div>
                    </div>
                    <!-- Columna Derecha: Partida -->
                    <div class="setup-column">
                        <h4>PARTIDA</h4>
                        <div class="setup-option">
                            <label for="gameModeSelect">Modo</label>
                            <select id="gameModeSelect">
                                <option value="development" selected>Desarrollo</option>
                                <option value="invasion">Invasi√≥n</option>
                            </select>
                        </div>
                        <div class="setup-option">
                            <label for="initialUnitsCount">Unidades</label>
                            <select id="initialUnitsCount">
                                <option value="1">1</option>
                                <option value="3" selected>3</option>
                                <option value="5">5</option>
                                <option value="unlimited">Max</option>
                            </select>
                        </div>
                        <div class="setup-option">
                            <label for="turnTimeSelect">Tiempo</label>
                            <select id="turnTimeSelect">
                                <option value="90">90 seg</option>
                                <option value="180" selected>3 min</option>
                                <option value="300">5 min</option>
                                <option value="600">10 min</option>
                                <option value="none">Sin l√≠mite</option>
                            </select>
                        </div>
                    </div>
                </div>
                <!-- Barbaros -->
                <div class="setup-option">
                    <label for="barbarianDensity">Ciudades Indep.</label>
                    <select id="barbarianDensity">
                        <option value="none">Ninguna</option>
                        <option value="low">Pocas</option>
                        <option value="med" selected>Normal</option>
                        <option value="high">Muchas</option>
                    </select>
                </div>
                <!-- Victoria por Puntos -->
                <div class="setup-option">
                    <label for="victoryByPoints">Victoria por Puntos</label>
                    <select id="victoryByPoints">
                        <option value="enabled" selected>Activada (8 puntos)</option>
                        <option value="disabled">Desactivada</option>
                    </select>
                </div>
                <!-- Slider -->
                <div class="players-row">
                    <label for="num-players-slider">Jugadores: <span id="num-players-display">2</span></label>
                    <input type="range" id="num-players-slider" min="2" max="8" value="2" step="1">
                    <select id="new-num-players" style="display: none;"></select>
                </div>
            </main>
            <footer class="modal-footer">
                <button id="backToMainMenuBtn_fromSetup" class="button-secondary">Volver</button>
                <button id="next-to-player-setup-btn" class="button-primary">Siguiente</button> 
            </footer>
        </div>
    </div>

    <!-- ========================================================================= -->
    <!-- === NUEVO MODAL: CONFIGURACI√ìN DE PARTIDA - PANTALLA 2 (JUGADORES)    === -->
    <!-- ========================================================================= -->
    <div id="setupScreen2" class="modal-overlay"> <!-- Nuevo ID para la pantalla 2 -->
        <div class="modal-container" style="max-width: 90vw;"> <!-- M√°s ancha para las columnas -->
            
            <header class="modal-header">
                <h2>Selecci√≥n de Facciones</h2>
                <!-- No necesita bot√≥n 'X', se vuelve con 'Atr√°s' -->
            </header>
            
            <main class="modal-body">
                <!-- El contenedor donde JS generar√° las columnas de jugador -->
                <div id="player-setup-grid" class="player-grid-container">
                    <!-- Ejemplo de c√≥mo se ver√≠a una columna (no lo a√±adas, es para referencia):
                    <div class="player-card">
                        <span class="player-icon">üë§</span>
                        <div class="form-group">
                            <select id="player1Type"> ... </select>
                        </div>
                        <div class="form-group">
                            <select id="player1Civ"> ... </select>
                        </div>
                    </div>
                    -->
                </div>
            </main>

            <footer class="modal-footer">
                 <!-- Bot√≥n para volver a la Pantalla 1 -->
                 <button id="back-to-global-setup-btn" class="button-secondary">Atr√°s</button>
                 <!-- REUTILIZAMOS tus botones originales -->
                 <button id="createNetworkGameBtn">Crear Partida en Red</button>
                 <button id="startLocalGameBtn" class="button-primary">Empezar Partida</button>
            </footer>
        </div>
    </div>

    <!-- ====================================================================== -->
    <!-- ========= PANTALLA DE LOBBY DEL ANFITRI√ìN (ESPERANDO JUGADOR) ======== -->
    <!-- ====================================================================== -->
    <div id="hostLobbyScreen" class="modal" style="display: none;">
        <div class="modal-content">
            <h2>Lobby de Partida en Red</h2>
            <div class="container">
                <h3>Tu partida est√° lista</h3>
                <p>Comparte este c√≥digo con el otro jugador para que pueda unirse:</p>
                <p style="font-size: 1.8em; font-weight: bold; color: #007bff; letter-spacing: 3px; margin: 15px 0; user-select: all;" id="short-game-code">Generando...</p>
                <p><i>El juego comenzar√° autom√°ticamente cuando se una.</i></p>
            </div>
            <div class="container">
                <p>Estado: <span id="host-status" class="status desconectado">Esperando jugador...</span></p>
                <ul id="host-player-list">
                    <!-- Los nombres de los jugadores aparecer√°n aqu√≠ -->
                </ul>
            </div>
            <button id="backToMainMenuBtn_fromHostLobby" style="margin-top:20px; background-color: #6c757d;">Cancelar y Volver</button>
        </div>
    </div>

    <!-- ====================================================================== -->
    <!-- ======================= MODAL DEL CUARTEL (H√âROES) =================== -->
    <!-- ====================================================================== -->
    <div id="barracksModal" class="modal modal-themed" style="display: none;">
        <div class="modal-content" style="max-width: 800px;">
            <header class="modal-header">
                <h2>Cuartel de H√©roes</h2>
                <span class="close-button" id="closeBarracksBtn">√ó</span>
            </header>
            
            <main class="modal-body">
                <div id="heroCollectionContainer" class="hero-collection-grid">
                    <!-- JS insertar√° aqu√≠ las tarjetas -->
                </div>
            </main>
        </div>
    </div>
    <!-- ====================================================================== -->
    <!-- ====== MODAL DETALLES DE H√âROE (ESTRUCTURA CORREGIDA PARA EQUIPO) ====== -->
    <!-- ====================================================================== -->
    <div id="heroDetailModal" class="modal modal-themed" style="display: none;">
        <div class="modal-content hero-detail-content-rok">
            <span class="close-button" id="closeHeroDetailBtn">√ó</span>
        
        <!-- CUERPO PRINCIPAL (Layout de 3 columnas) -->
            <div class="hero-main-layout">

            <!-- COLUMNA IZQUIERDA: HABILIDADES (Sin cambios) -->
                <div class="hero-column hero-skills-column">
                    <h3 class="column-title">Habilidades</h3>
                    <div id="heroDetailSkillsContainer" class="skills-list">
                        <!-- Las 4 habilidades se insertar√°n aqu√≠ con JS -->
                    </div>
                </div>

            <!-- COLUMNA CENTRAL: RETRATO, STATS Y PROGRESI√ìN (Sin cambios) -->
                <div class="hero-column hero-center-column">
                    <div id="hero-portrait-container"></div>
                    <div id="hero-name-title" class="hero-name-title">
                        <h2 id="heroDetailName">Nombre H√©roe</h2>
                        <p id="heroDetailTitle">T√≠tulo del H√©roe</p>
                    </div>
                    <div id="hero-progression-bars">
                        <div class="progress-item">
                            <span>Nivel: <strong id="heroDetailLevel">1</strong></span>
                            <div class="xp-bar-container"><div id="heroDetailXpBar" class="xp-bar"></div></div>
                            <span id="heroDetailXpText">0/1000</span>
                        </div>
                        <div class="progress-item">
                            <span>Evoluci√≥n: <strong id="heroDetailStars">‚≠ê</strong></span>
                            <div class="xp-bar-container"><div id="heroDetailFragmentBar" class="xp-bar fragments"></div></div>
                            <span id="heroDetailFragmentText">0/20</span>
                        </div>
                    </div>
                </div>

            <!-- <<== CORRECCI√ìN: COLUMNA DERECHA AHORA ES SOLO EQUIPO ==>> -->
            <!-- ... dentro de .hero-equipment-column ... -->
                <div class="equipment-layout">
                    <div class="equip-row-single">
                        <div class="equipment-slot" id="equip-head"><span>Casco</span></div>
                    </div>
                    <div class="equip-row-middle">
                        <div class="equipment-slot" id="equip-gloves"><span>Guantes</span></div>
                        <div class="equipment-slot" id="equip-chest"><span>Coraza</span></div>
                        <div class="equipment-slot" id="equip-weapon"><span>Arma</span></div>
                        <div class="equipment-slot" id="equip-legs"><span>Pantal√≥n</span></div>
                    </div>
                    <div class="equip-row-single">
                        <div class="equipment-slot" id="equip-boots"><span>Botas</span></div>
                    </div>
                </div>
            
        </div> <!-- Fin de .hero-main-layout -->

        <!-- <<== CORRECCI√ìN: PIE DE P√ÅGINA CON BOTONES DE ACCI√ìN ==>> -->
            <div class="hero-detail-footer">
                <button id="openTalentTreeBtn" class="talent-button">Talentos</button>
                <div class="upgrade-buttons">
                    <button id="heroLevelUpBtn">Usar Libros XP</button>
                    <button id="heroEvolveBtn">Evolucionar</button>
                </div>
            </div>

        </div>
    </div>

<!-- ====================================================================== -->
<!-- ============== MODAL DE √ÅRBOL DE TALENTOS              ================ -->
<!-- ====================================================================== -->
    <div id="talentTreeModal" class="modal" style="display: none; background-color: rgba(10, 20, 30, 0.9);">
        <div class="modal-content talent-tree-modal-content">
            <span class="close-button" id="closeTalentTreeModalBtn">√ó</span>
            <div class="talent-modal-header">
                <h2 id="talentHeroName">Talentos de [Nombre H√©roe]</h2>
                <div class="talent-points-counter">Puntos: <span id="talentPointsAvailable">0</span></div>
                <button id="resetTalentsBtn">Reiniciar</button>
            </div>
        
        <!-- Contenedor √öNICO para nexo y √°rbol -->
        <div id="talentCanvasContainer" class="talent-canvas-container">
            <!-- El nexo y el √°rbol se dibujar√°n aqu√≠ con JS -->
        </div>
        </div>
    </div>

<!-- ====================================================================== -->
<!-- ============= MODAL DE SELECCI√ìN DE EQUIPO             ================ -->
<!-- ====================================================================== -->
    <div id="equipmentSelectorModal" class="modal modal-themed" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <span class="close-button" id="closeEquipmentSelectorBtn">√ó</span>
            <h2 id="equipmentSelectorTitle">Seleccionar [Slot]</h2>
            <p>Elige una pieza de equipo de tu inventario para equipar a este h√©roe.</p>
            <div id="equipmentListContainer" class="equipment-list"></div>
            <div id="equipmentSelectorFooter" style="text-align: center; margin-top: 20px; display: none;">
                <button id="equipItemBtn">Equipar Objeto Seleccionado</button>
                <button id="unequipItemBtn" style="background-color: #dc3545;">Quitar Objeto Actual</button>
            </div>
        </div>
    </div>

    <!-- ====================================================================== -->
    <!-- Modal: Bolsa de Objetos -->
    <!-- ====================================================================== -->
    <div id="inventoryModal" class="modal modal-themed" style="display: none;">
        <div class="modal-content" style="max-width: 900px; height: 80vh;">
            <header class="modal-header">
                <h2>Bolsa del General</h2>
                <span class="close-button" id="closeInventoryBtn">√ó</span>
            </header>

            <div class="gacha-main-layout" style="grid-template-columns: 200px 1fr 250px;">
                <!-- Izquierda: Categor√≠as -->
                <div class="gacha-column">
                    <h3>Cat.</h3>
                    <button class="gacha-button" onclick="InventoryManager.filter('all')">üì¶ Todo</button>
                    <button class="gacha-button" onclick="InventoryManager.filter('resources')">üí∞ Res.</button>
                    <button class="gacha-button" onclick="InventoryManager.filter('consumables')">üíä Obj.</button>
                    <button class="gacha-button" onclick="InventoryManager.filter('fragments')">üéñÔ∏è Frag.</button>
                    <button class="gacha-button" onclick="InventoryManager.filter('equipment')">üõ°Ô∏è Eqp.</button>
                </div>

                <!-- Centro: Rejilla de Objetos -->
                <div class="gacha-column">
                    <div id="inventoryGrid" class="hero-collection-grid" style="background: rgba(0,0,0,0.2); max-height: none;">
                        <!-- Los items se generar√°n aqu√≠ -->
                    </div>
                </div>

                <!-- Derecha: Detalles del objeto seleccionado -->
                <div class="gacha-column" id="inventoryDetailPanel">
                    <h3>Detalles</h3>
                    <div id="itemDetailPlaceholder" style="text-align: center; color: #888; margin-top: 50px;">
                        <p>Selecciona un objeto para ver sus detalles.</p>
                    </div>
                    <div id="itemDetailContent" style="display: none; text-align: center;">
                        <div id="itemDetailIcon" style="font-size: 4em; margin-bottom: 15px;"></div>
                        <h2 id="itemDetailName" style="color: #f1c40f;"></h2>
                        <p id="itemDetailDescription" style="font-style: italic; color: #bdc3c7;"></p>
                        <hr style="border-color: #444;">
                        <p id="itemDetailQuantity" style="font-weight: bold;"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ====================================================================== -->
    <!-- ============= POP-UP DE DETALLES DE HABILIDAD (MODAL) ================ -->
    <!-- ====================================================================== -->
    <div id="skillDetailModal" class="modal" style="display: none; background-color: rgba(0,0,0,0.7);">
        <div class="modal-content skill-detail-content">
            <span class="close-button" id="closeSkillDetailBtn">√ó</span>
            <div class="skill-detail-header">
                <div id="skillDetailIcon" class="skill-icon"></div>
                <div class="skill-header-info">
                    <h3 id="skillDetailName">Nombre de la Habilidad</h3>
                    <p id="skillDetailCurrentLevel">Nivel Actual: 1/5</p>
                </div>
            </div>
            <div class="skill-detail-body">
                <p id="skillDetailDescription">Descripci√≥n general de lo que hace la habilidad.</p>
                <hr>
                <h4>Vista Previa de Niveles</h4>
                <div id="skillLevelPreview">
                    <!-- Los niveles se insertar√°n aqu√≠ con JS -->
                </div>
            </div>
            <div class="skill-detail-footer">
                <span id="skillUpgradeCost">Coste: 1 Punto de Habilidad</span>
                <button id="upgradeSkillBtn">MEJORAR</button>
            </div>
        </div>
    </div>
    
    <!-- ====================================================================== -->
    <!-- =================== PANTALLA DEL ARBOL DE TECNOLOG√çA ================== -->
    <!-- ====================================================================== -->
    <div id="techTreeScreen" class="modal" style="display: none; background-color: rgba(0,0,0,0.85);">
        <div class="modal-content tech-tree-content" style="width: 80%; max-width: 700px; height: 70vh; overflow: auto; background-color: #1e2a38; border: 2px solid #4a5568; box-shadow: 0 0 20px rgba(0,0,0,0.5); border-radius: 10px;">
            <span class="close-button" id="closeTechTreeBtn" title="Cerrar">√ó</span>
            <h2 style="text-align: center; color: #e2e8f0; margin-top:15px; margin-bottom: 15px; font-size: 1.5em;">√Årbol de Tecnolog√≠as</h2>
            <div id="techTreeContainer" style="position: relative; width: 1500px; height: 1000px; background-color: #2d3748; margin: 0 auto; border-radius: 5px;"></div>
        </div>
    </div>

    <!-- ====================================================================== -->
    <!-- ============= MODAL DE DETALLE DE TECNOLOG√çA (NUEVO) =============== -->
    <!-- ====================================================================== -->
    <div id="techDetailModal" class="modal modal-themed" style="display: none;">
        <div class="modal-content" style="max-width: 450px;">
            <span class="close-button" id="closeTechDetailBtn">√ó</span>
            
            <!-- Cabecera con Icono y Nombre -->
            <div id="techDetailHeader" style="display: flex; align-items: center; gap: 15px; border-bottom: 1px solid #7f8c8d; padding-bottom: 10px; margin-bottom: 15px;">
                <span id="techDetailIcon" style="font-size: 3em;">üí°</span>
                <h2 id="techDetailName" style="margin: 0; color: #f1c40f;">Nombre de la Tecnolog√≠a</h2>
            </div>
            
            <!-- Cuerpo con los detalles -->
            <div id="techDetailBody">
                <p id="techDetailDescription" style="font-style: italic; color: #bdc3c7; min-height: 50px;">Aqu√≠ va la descripci√≥n completa de la tecnolog√≠a y lo que representa en el juego.</p>
                
                <div id="techDetailInfoGrid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.9em;">
                    <div><strong>Costo:</strong> <span id="techDetailCost">--</span></div>
                    <div><strong>Requiere:</strong> <span id="techDetailPrereqs">--</span></div>
                    <div style="grid-column: 1 / -1;"><strong>Desbloquea:</strong> <span id="techDetailUnlocks">--</span></div>
                </div>
            </div>
            
            <!-- Pie de p√°gina con los botones -->
            <div id="techDetailFooter" style="text-align: center; margin-top: 20px; border-top: 1px solid #7f8c8d; padding-top: 15px;">
                <button id="researchTechBtn" class="button-primary" style="padding: 10px 30px; font-size: 1.1em; font-weight: bold;">Investigar</button>
            </div>
        </div>
    </div>

    <!-- ====================================================================== -->
    <!-- =================== PANTALLA DEL MAPA MUNDIAL (CAMPA√ëA) =================== -->
    <!-- ====================================================================== -->
    <div id="worldMapScreen" style="display: none; position: relative; width: 90%; max-width: 960px; height: 640px; margin: 20px auto; border: 2px solid #333; background-color: #a7bbc7; overflow: hidden;">
        <img id="worldMapImage" src="" alt="Mapa del Mundo" style="width: 100%; height: 100%; object-fit: contain;">
        <div id="territoryMarkerContainer" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;"></div>
        <div id="campaignMessages" class="floating-messages bottom-left">Mensajes de campa√±a...</div>
        <button id="backToMainMenuBtn_fromCampaign" class="floating-btn top-right" style="font-size: 16px; width: auto; padding: 5px 10px; border-radius: 5px;">Men√∫</button>
    </div>

    <!-- ====================================================================== -->
    <!-- ================== MODAL DE BRIEFING DEL ESCENARIO ================== -->
    <!-- ====================================================================== -->
    <div id="scenarioBriefingModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 700px;">
            <span class="close-button" id="closeScenarioBriefingBtn" title="Cerrar">√ó</span>
            <h2 id="scenarioTitle" style="text-align:center; margin-bottom:15px;">T√≠tulo</h2>
            <img id="scenarioImage" src="" alt="Escenario" style="max-width: 100%; max-height: 300px; margin:0 auto 20px; display:none;">
            <p id="scenarioDescription">Descripci√≥n...</p>
            <button id="startScenarioBattleBtn" style="font-size: 1.1em; padding: 12px 20px;">Comenzar Batalla</button>
        </div>
    </div>

    <!-- ====================================================================== -->
    <!-- =================== MODAL DE DETALLES DE DIVISI√ìN ==================== -->
    <!-- ====================================================================== -->
    <div id="unitDetailModal" class="modal modal-themed" style="display: none;">
        <div class="modal-content unit-detail-content">
            <span class="close-button" id="closeUnitDetailModalBtn">√ó</span>
            <h3 id="unitDetailTitle">Detalles de la Divisi√≥n</h3>
            <div class="unit-main-stats">
                <div class="stat-row">
                    <span class="stat-label">Salud:</span>
                    <div class="unit-total-health-bar-container">
                        <div id="unitDetailTotalHealthBar" class="unit-total-health-bar"></div>
                    </div>
                    <span id="unitDetailTotalHealthText">2000 / 2000</span>
                </div>
                <div class="stat-row stat-summary">
                    <span id="unitDetailCombatStats">A/D: 400/600</span>
                    <span id="unitDetailMovementStats">Mov: 2</span>
                    <span id="unitDetailVisionStats">Vis: 3</span>
                </div>
                <div class="stat-row">
                    <span id="unitDetailMorale">Moral: 50/125 (Normal)</span>
                    <span id="unitDetailXP">XP: 120/150 (Regular)</span>
                </div>
            </div>
            <h4 class="regiment-section-title">Regimientos</h4>
            <ul id="unitDetailRegimentList" class="regiments-list detailed-regiments-list"></ul>
            <div id="unitDetailFooter" style="text-align: center; margin-top: 20px; border-top: 1px solid #ccc; padding-top: 15px;">
                <button id="disbandUnitBtn" class="button-danger">Disolver Unidad</button>
            </div>
        </div>
    </div>
    
    <!-- ====================================================================== -->
    <!-- ======================= MODAL DE LA WIKI DEL JUEGO ===================== -->
    <!-- ====================================================================== -->
    <div id="wikiModal" class="modal" style="display: none;">
        <div class="modal-content wiki-content">
            <span class="close-button" id="closeWikiModalBtn">√ó</span>
            <h2>Wiki del Juego</h2>
            <div class="wiki-tabs">
                <button class="wiki-tab-btn active" data-tab="regimientos">Regimientos</button>
                <button class="wiki-tab-btn" data-tab="estructuras">Estructuras</button>
                <button class="wiki-tab-btn" data-tab="tecnologias">Investigaci√≥n</button>
                <button class="wiki-tab-btn" data-tab="heroes">H√©roes</button> <!-- Nueva -->
                <button class="wiki-tab-btn" data-tab="comercio">Banca</button> <!-- Nueva -->
                <button class="wiki-tab-btn" data-tab="victoria">Victoria</button> <!-- Nueva -->
                <button class="wiki-tab-btn" data-tab="conceptos">Conceptos</button>
                <button class="wiki-tab-btn" data-tab="logros">üéñÔ∏è Logros</button>
            </div>

            <div class="wiki-tab-content">
                <div id="wiki-tab-regimientos" class="wiki-page active">
                    <p>Valoraciones de 1 a 5 estrellas (‚≠ê) para Ataque, Defensa, Salud, Movimiento y Rango.</p>
                    <div class="table-container"><table id="wikiRegimentsTable"></table></div>
                </div>
                
                <div id="wiki-tab-estructuras" class="wiki-page">
                    <h3>Estructuras</h3>
                    <div class="table-container"><table id="wikiStructuresTable"></table></div>
                    <h3>Ingresos por Territorio (Base)</h3>
                    <div class="table-container"><table id="wikiIncomeTable"></table></div>
                </div>
                
                <div id="wiki-tab-tecnologias" class="wiki-page">
                    <p>Las tecnolog√≠as desbloquean nuevas unidades y estructuras.</p>
                    <div class="table-container"><table id="wikiTechTable"></table></div>
                </div>

                <div id="wiki-tab-heroes" class="wiki-page">
                    <p>Los H√©roes mejoran el rendimiento de su divisi√≥n asignada.</p>
                </div> <!-- Contenedor nuevo -->
                
                <div id="wiki-tab-comercio" class="wiki-page">
                    <p>La Banca es un buen aliado econ√≥mico a largo Plazo</p>
                </div> <!-- Contenedor nuevo -->
                
                <div id="wiki-tab-victoria" class="wiki-page">
                    <p>La Victoria no solo se consigue luchando.</p>
                </div> <!-- Contenedor nuevo -->
                
                <div id="wiki-tab-conceptos" class="wiki-page">
                    <h3>Conceptos Clave del Juego</h3>
                    <div id="wikiConceptsContent"></div>
                </div>

                <div id="wiki-tab-logros" class="wiki-page">
                    <h3>Haza√±as del General</h3>
                    <p>Completa estos desaf√≠os para obtener recursos adicionales.</p>
                    <div id="wikiAchievementsList">
                        <!-- JS llenar√° esto con los logros de Supabase -->
                        <p>Cargando tus haza√±as...</p>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- ====================================================================== -->
    <!-- =================== MODALES DE JUEGO T√ÅCTICO ========================= -->
    <!-- ====================================================================== -->

    <div id="unitManagementModal" class="modal modal-themed" style="display: none;">
        <div class="modal-content unit-management-content">
            <span class="close-button" id="closeUnitManagementModalBtn">√ó</span>
            <h3 id="unitManagementTitle">Crear Nueva Divisi√≥n</h3>
            <div class="unit-management-body">
                <div class="unit-selection-panel">
                    <div id="unitCategoryTabs" class="category-tabs"></div>
                    <div id="availableUnitsList" class="available-units-list"></div>
                </div>
                <div class="division-summary-panel">
                    <!-- El input para el nombre ahora est√° arriba del todo -->
                    <input type="text" id="divisionNameInput" value="Nueva Divisi√≥n" maxlength="25" placeholder="Nombre de la Divisi√≥n...">

                    <!-- Esta es la lista que tendr√° el scroll si es necesario -->
                    <ul id="divisionCompositionList" class="compact-composition-list">
                        <!-- JS generar√° el contenido aqu√≠, ej: <li>‚öîÔ∏è x5</li> -->
                    </ul>
                    
                    <!-- El resumen de coste y stats queda abajo, siempre visible -->
                    <div class="summary-details">
                        <p><strong>Coste:</strong> <span id="divisionCostSummary">0 Oro</span></p>
                        <p><strong>Stats:</strong> <span id="divisionStatsSummary">A:0 D:0 M:0</span></p>
                        <p><strong>Regimientos:</strong> <span id="divisionRegimentCount">0 / 20</span></p>
                    </div>
                </div>
            </div>
            <div class="modal-footer-actions">
                <button id="cancelUnitManagementBtn" class="button-secondary">Cancelar</button>
                <button id="finalizeUnitManagementBtn">Finalizar y Colocar</button>
            </div>
        </div>
    </div>
    
    <div id="buildStructureModal" class="modal modal-themed">
        <div class="modal-content">
            <header class="modal-header">
                <h3>Construir en (<span id="buildHexCoordsDisplay"></span>)</h3>
                <span class="close-button">√ó</span>
            </header>
            
            <main class="modal-body">
                <p style="font-size: 0.9em; color: #bdc3c7; margin-bottom: 10px;">Selecciona la estructura que deseas levantar en esta casilla:</p>
                <ul id="availableStructuresList">
                    <!-- JS llenar√° esto -->
                </ul>
            </main>

            <footer class="modal-footer">
                <button id="confirmBuildBtn" class="button-primary">Confirmar Construcci√≥n</button>
            </footer>
        </div>
    </div>

    <div id="advancedSplitUnitModal" class="modal modal-themed" style="display: none;">
        <div class="modal-content" style="max-width: 800px;">
            <span class="close-button" id="closeAdvancedSplitModalBtn">√ó</span>
            <h3>Dividir <span id="advancedSplitUnitNameDisplay"></span></h3>
            <p style="font-size: 0.9em;">Mueve regimientos para formar una nueva unidad.</p>
            <div class="split-regiment-container">
                <div class="regiment-column">
                    <h4>Unidad Original (<span id="originalUnitRegimentCount"></span>)</h4>
                    <p>Stats: <span id="originalUnitPreviewStats"></span></p>
                    <p>Salud: <span id="originalUnitPreviewHealth"></span></p>
                    <ul id="originalUnitRegimentsList" class="regiments-list"></ul>
                </div>
                <div class="regiment-column">
                    <h4>Nueva Unidad (<span id="newUnitRegimentCount"></span>)</h4>
                    <input type="text" id="newSplitUnitNameInput" value="Nueva Divisi√≥n" maxlength="20">
                    <p>Stats: <span id="newUnitPreviewStats"></span></p>
                    <p>Salud: <span id="newUnitPreviewHealth"></span></p>
                    <ul id="newUnitRegimentsList" class="regiments-list"></ul>
                </div>
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button id="finalizeAdvancedSplitBtn">Confirmar Divisi√≥n</button>
                <button id="cancelAdvancedSplitBtn" style="background-color: #6c757d;">Cancelar</button>
            </div>
        </div>
    </div>
       
    <!-- ====================================================================== -->
    <!-- ======================= modal para la selecci√≥n de rutas ================ -->
    <!-- ====================================================================== -->
    <div id="routeSelectorModal" class="modal modal-themed" style="display: none; z-index: 10006;">
        <div class="modal-content" style="max-width: 400px; max-height: 250px;">
            <span class="close-button" id="closeRouteSelectorBtn">√ó</span>
            <h3 style="font-size: 11px; color: #00f3ff; border-bottom: 1px solid #1a2a33; padding-bottom: 4px;">ESTABLECER RUTA COMERCIAL</h3>
            <div id="routeListContainer" style="overflow-y: auto; flex-grow: 1; margin: 10px 0;">
                <!-- Aqu√≠ JS inyectar√° las rutas encontradas -->
            </div>
        </div>
    </div>

    <!-- ====================================================================== -->
    <!-- ======================= modal resumen de partida ================ -->
    <!-- ====================================================================== -->

    <div id="postMatchModal" class="modal modal-themed" style="display: none;">
        <div class="modal-content" style="max-width: 500px; text-align: center;">
            <h2 id="matchResultTitle" style="font-size: 2.5em; margin: 10px 0;">¬°VICTORIA!</h2>
            <div id="mvpHeroContainer"></div>
            
            <div style="margin: 20px 0;">
                <p>Nivel de Comandante: <strong id="playerLevelDisplay">1</strong></p>
                <div class="xp-bar-container" style="height: 25px; background: #1a2a33; border: 2px solid #7f8c8d;">
                    <div id="playerXpBar" class="xp-bar" style="width: 0%; background: linear-gradient(to right, #f1c40f, #e67e22);"></div>
                </div>
                <p id="xpGainedDisplay">+450 XP ganada</p>
            </div>

            <div id="matchStatsGrid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.9em; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 5px;">
                <!-- Stats din√°micas -->
            </div>

            <button id="closePostMatchBtn" class="button-primary" style="margin-top: 20px; width: 100%; padding: 15px;">VOLVER AL CUARTEL GENERAL</button>
        </div>
    </div>
    
    <!-- ====================================================================== -->
    <!-- ======================= MODAL DEL ALTAR DE DESEOS (GACHA) ================ -->
    <!-- ====================================================================== -->
    <div id="deseosModal" class="modal modal-themed" style="display: none;">
        <div class="modal-content" style="max-width: 900px; height: 500px;">
            <span class="close-button" id="closeDeseosBtn">√ó</span>
            
            <!-- Contenedor principal de 3 columnas -->
            <div class="gacha-main-layout">
                
                <!-- Columna Izquierda: Historial -->
                <div class="gacha-column gacha-history-column">
                    <h3>Historial de Premios</h3>
                    <ul id="gacha-history-list">
                        <!-- El historial se llenar√° aqu√≠ con JS -->
                        <li class="history-item-placeholder">Realiza una tirada para ver tus premios.</li>
                    </ul>
                </div>

                <!-- Columna Central: Animaci√≥n de Premios -->
                <div class="gacha-column gacha-animation-column">
                    <div id="gacha-reveal-area">
                        <!-- Aqu√≠ aparecer√°n las "cartas" de los premios -->
                        <div class="reveal-placeholder">
                            <p>Tus premios aparecer√°n aqu√≠</p>
                            <span class="placeholder-icon">‚ú®</span>
                        </div>
                    </div>
                </div>

                <!-- Columna Derecha: Acciones -->
                <div class="gacha-column gacha-actions-column">
                    <h3>Altar de los Deseos</h3>
                    <p>Sellos de Guerra: <strong id="gacha-sellos-count">0</strong></p>
                    
                    <button id="gacha-pull-10" class="gacha-button pull-10">
                        <span class="button-main-text">Pedir 10 Deseos</span>
                        <span class="button-cost">10 Sellos</span>
                    </button>
                    <button id="gacha-pull-1" class="gacha-button pull-1">
                        <span class="button-main-text">Pedir 1 Deseo</span>
                        <span class="button-cost">1 Sello</span>
                    </button>
                    <button id="gacha-pull-free" class="gacha-button pull-free" disabled>
                        <span class="button-main-text">Tirada Gratis</span>
                        <span id="gacha-free-timer" class="button-cost">Pr√≥ximamente...</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ====================================================================== -->
    <!-- ======================= MODAL DE LA FORJA (EQUIPO) =================== -->
    <!-- ====================================================================== -->
    <div id="forgeModal" class="modal modal-themed" style="display: none;">
        <div class="modal-content" style="max-width: 800px;">
            <span class="close-button" id="closeForgeBtn">√ó</span>
            <h2>Forja del General</h2>
            <p>Aqu√≠ puedes usar los fragmentos que has conseguido para forjar poderosas piezas de equipo.</p>
            
            <div class="forge-container">
                <!-- Columna Izquierda: Lista de Planos -->
                <div id="blueprintList" class="blueprint-list">
                    <!-- Los planos se insertar√°n aqu√≠ con JS -->
                </div>

                <!-- Columna Derecha: Detalles del Plano Seleccionado -->
                <div id="blueprintDetail" class="blueprint-detail">
                    <div id="blueprintDetailPlaceholder" style="text-align: center; margin-top: 50px; color: #888;">
                        <p>Selecciona un plano de la izquierda para ver sus detalles y forjarlo.</p>
                    </div>
                    <div id="blueprintDetailContent" style="display: none;">
                        <div id="blueprintItemIcon" class="item-icon-large"></div>
                        <h3 id="blueprintItemName">Nombre del Objeto</h3>
                        <p id="blueprintItemStats"></p>
                        <hr>
                        <h4>Progreso de Forja</h4>
                        <div class="forge-progress-item">
                            <div class="xp-bar-container">
                                <div id="blueprintFragmentBar" class="xp-bar fragments"></div>
                            </div>
                            <span id="blueprintFragmentText">0 / 20</span>
                        </div>
                        <button id="forgeItemBtn" style="width: 100%; padding: 12px; font-size: 1.2em; margin-top: 20px;">FORJAR</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ====================================================================== -->
    <!-- ======================= MODAL DE LA BANCA (MERCADO) ================== -->
    <!-- ====================================================================== -->
    
    <div id="bankModal" class="modal modal-themed" style="display: none;">
        <div class="modal-content compact-modal"> <!-- Nueva clase 'compact-modal' -->
            
            <div class="compact-header">
                <h2>Mercado de La Banca</h2>
                <span class="close-button" id="closeBankModalBtn">√ó</span>
            </div>
            
            <!-- Pesta√±as -->
            <div class="inbox-tabs">
                <!-- Usamos una nueva clase √∫nica 'bank-tab-btn' -->
                <button class="bank-tab-btn active" data-tab="resources">Recursos 4:1</button>
                <button class="bank-tab-btn" data-tab="offers">Tabl√≥n de Ofertas</button>
            </div>

            <!-- Contenido de las Pesta√±as -->
            <div class="inbox-tab-content">
                <div id="bank-tab-resources" class="wiki-page active">
                    <p>Intercambia recursos con La Banca a un tipo de 4:1.</p>
                    <div class="bank-trade-interface">
                        <!-- Columna: Ofrecer -->
                        <div class="trade-column">
                            <h4>Ofrecer</h4>
                            <select id="bankOfferResourceSelect">
                                <option value="oro">Oro</option>
                                <option value="hierro">Hierro</option>
                                <option value="piedra">Piedra</option>
                                <option value="madera">Madera</option>
                                <option value="comida">Comida</option>
                            </select>
                            <input type="number" id="bankOfferAmountInput" value="100" min="4" step="4">
                            <p>Tienes: <span id="bankPlayerResourceAmount">0</span></p>
                        </div>

                        <!-- Flecha de intercambio -->
                        <div class="trade-arrow">
                            <span>‚Üí</span>
                        </div>

                        <!-- Columna: Recibir -->
                        <div class="trade-column">
                            <h4>Recibir</h4>
                            <select id="bankRequestResourceSelect">
                                <option value="oro">Oro</option>
                                <option value="hierro">Hierro</option>
                                <option value="piedra">Piedra</option>
                                <option value="madera">Madera</option>
                                <option value="comida">Comida</option>
                            </select>
                            <input type="number" id="bankRequestAmountInput" value="25" readonly>
                            <p class="ratio-text">Ratio 4:1</p> <!-- Texto m√°s simple -->
                        </div>
                    </div>
                    <button id="bankConfirmTradeBtn" class="button-primary">Confirmar Intercambio</button>
                </div>

                <!-- Pesta√±a 2: Tabl√≥n de Ofertas (solo la estructura, sin funcionalidad) -->
                <div id="bank-tab-offers" class="wiki-page">
                    <p>Crea y acepta ofertas de intercambio de sellos con otros jugadores.</p>
                    <p style="text-align: center; color: #888; margin-top: 50px;">(Funcionalidad pr√≥ximamente)</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ====================================================================== -->
    <!-- ======================= BUZ√ìN DEL GENERAL (Misiones, Banners, Mensajes) -->
    <!-- ====================================================================== -->
    <div id="inboxModal" class="modal">
        <!-- El bot√≥n X flotando sobre la interfaz pero fuera del contenido -->
        <div id="closeInboxBtn" class="close-button" style="z-index: 10005;">X</div>
        
        <div class="modal-content" style="display: flex; flex-direction: column;">
            <div class="inbox-tabs">
                <button class="inbox-tab-btn active" data-tab="missions">Misiones</button>
                <button class="inbox-tab-btn" data-tab="banners">H√©roes</button>
                <button class="inbox-tab-btn" data-tab="messages">Sistema</button>
            </div>

            <div style="display: flex; flex-grow: 1; height: calc(100% - 22px);">
                <div id="inboxListContainer"></div>
                
                    
                    <!-- Reemplaza el bloque 'inboxDetailContainer' en index.html -->
                    <div id="inboxDetailContainer">
                        <div id="inboxDetailPlaceholder">SELECCIONE UN INFORME DE COMUNICACIONES...</div>
                        
                        <!-- Este es el contenedor real del contenido que se activa en JS -->
                        <div id="inboxDetailContent" style="display:none;">
                            <h3 id="inboxDetailTitle"></h3>
                            
                            <!-- Fila de imagen opcional -->
                            <div id="inboxDetailHeaderImage"></div>
                            
                            <!-- Fila del cuerpo del mensaje -->
                            <div id="inboxDetailBody"></div>
                            
                            <!-- Fila del Pie de p√°gina -->
                            <div id="inboxFooter">
                                <div id="inboxRewardSection"></div>
                                <button id="inboxClaimBtn"></button>
                            </div>
                        </div>
                    </div>
                
            </div>
        </div>
    </div>

    <div id="gameLogContainer" class="game-log-container"></div>

    <!-- ====================================================================== -->
    <!-- =============================== Alianza ============================== -->
    <!-- ====================================================================== -->
    
    <div id="allianceModal" class="modal modal-themed" style="display: none; z-index: 10030;">
        <!-- Eliminamos clases antiguas, usamos estructura 'Hub' -->
        <div class="modal-content ali-hub-window">
            
            <!-- HEADER COMPACTO -->
            <div class="ali-hub-header">
                <div class="ali-identity">
                    <div id="hqFlag" class="ali-flag-small">üõ°Ô∏è</div>
                    <div class="ali-titles">
                        <h2 id="hqName">[TAG] Nombre Alianza</h2>
                        <div class="ali-meta-row">
                            <span class="badge-lvl">Nvl <span id="hqLevel">1</span></span>
                            <span class="badge-lang">üåê <span id="hqLanguage">Global</span></span>
                            <span class="badge-power">‚öîÔ∏è <span id="hqPower">0</span></span>
                            <span class="badge-members">üë• <span id="hqMembers">0/50</span></span>
                        </div>
                    </div>
                </div>
                <div class="ali-header-actions">
                    <button id="aliLeaveBtn" class="btn-danger-icon" title="Abandonar">üö™</button>
                    <button id="closeAllianceBtn" class="close-button">√ó</button>
                </div>
            </div>

            <!-- CUERPO PRINCIPAL (L√ìGICA DE PANTALLAS) -->
            
            <!-- PANTALLA 1: BUSCADOR (Si no tienes alianza) -->
            <div id="aliView_Lobby" class="ali-lobby-layout" style="display:none;">
                <div class="search-bar-row">
                    <input type="text" id="aliSearchInput" placeholder="Buscar por nombre o etiqueta..." class="search-input">
                    <button id="aliSearchBtn" class="btn-action">üîç</button>
                    <button id="aliCreateModeBtn" class="btn-success">‚ûï Crear</button>
                </div>
                <!-- LISTA DE ALIANZAS: Densa y visual -->
                <div id="aliSearchResults" class="ali-list-grid">
                    <!-- Se rellena con JS -->
                </div>
                <!-- Formulario de creaci√≥n (oculto por defecto) -->
                <div id="aliCreateForm" class="create-form-overlay" style="display:none;">
                    <h3>Fundar Alianza</h3>
                    <div class="form-group">
                        <label>Estandarte</label>
                        <div class="emblem-selector" id="newAliEmblemSelector">
                            <div class="emb-opt selected">üõ°Ô∏è</div><div class="emb-opt">ü¶Å</div><div class="emb-opt">‚ò†Ô∏è</div>
                            <div class="emb-opt">‚öîÔ∏è</div><div class="emb-opt">ü¶Ö</div><div class="emb-opt">üëë</div>
                        </div>
                    </div>
                    <div class="form-row">
                        <input type="text" id="newAliName" placeholder="Nombre" maxlength="20">
                        <input type="text" id="newAliTag" placeholder="TAG (3)" maxlength="3" style="text-transform:uppercase; width: 60px;">
                    </div>
                    <div class="form-row">
                        <select id="newAliType"><option value="Open">Abierta</option><option value="Approval">Con Solicitud</option></select>
                        <select id="newAliLang"><option value="ES">Espa√±ol</option><option value="EN">English</option><option value="Global">Global</option></select>
                    </div>
                    <div class="form-actions">
                        <button onclick="document.getElementById('aliCreateForm').style.display='none'" class="btn-cancel">Cancelar</button>
                        <button id="aliCreateConfirmBtn" class="btn-confirm">Crear (500 üí∞)</button>
                    </div>
                </div>
            </div>

            <!-- PANTALLA 2: CUARTEL GENERAL (Dise√±o de Columna √önica) -->
            <div id="aliView_HQ" class="ali-hq-grid" style="display:none; flex-direction: column; height: 100%;">
                
                <!-- PANEL SUPERIOR: ESTADO DE GUERRA (Ultra Compacto) -->
                <div class="war-status-card" style="margin: 0 0 10px 0; flex-shrink: 0; padding: 8px 12px; display: flex; align-items: center; justify-content: space-between; height: 40px;">
                    <!-- Icono y T√≠tulo a la izquierda -->
                    <div style="display:flex; align-items:center; gap:10px;">
                        <div style="font-size:20px;">üê´</div>
                        <div style="display:flex; flex-direction:column; line-height:1.1;">
                            <strong style="font-size:11px; color:#fecaca;">CARAVANA IMPERIAL</strong>
                            <small id="raidBossHpText" style="font-size:9px; color:#aaa;">10k / 10k HP</small>
                            <small id="raidStageText" style="font-size:8px; color:#fbbf24; font-weight:bold;">ETAPA 1/4</small>
                        </div>
                    </div>

                    <!-- Barra de Vida en el centro (flexible) -->
                    <div class="hp-bar-container" style="flex-grow:1; margin:0 15px; height:8px; background:#000; border-radius:4px; border:1px solid #555;">
                        <div id="raidBossHpBar" class="hp-bar" style="width:100%; height:100%; background:linear-gradient(90deg, #ef4444, #b91c1c);"></div>
                    </div>

                    <!-- Bot√≥n a la derecha -->
                    <button id="btnAttackRaid" style="background:#dc2626; color:white; border:1px solid #f87171; font-weight:bold; cursor:pointer; padding:4px 10px; border-radius:4px; font-size:10px;">
                        ‚öîÔ∏è ATACAR
                    </button>
                </div>

                <!-- PANEL INFERIOR: LISTA DE MIEMBROS (Ocupa el resto) -->
                <div class="members-card" style="flex-grow: 1; padding: 0 10px 10px 10px; display: flex; flex-direction: column; min-height: 0;">
                    <div class="card-header" style="padding: 5px 0; border-bottom: 1px solid #334155; margin-bottom: 5px; display: flex; justify-content: space-between;">
                        <span style="color: #94a3b8; font-weight: bold;">MIEMBROS DEL CLAN</span>
                        <span id="memberCountDisplay" style="color: #f1c40f;">0/50</span>
                    </div>
                    <div id="membersListCompact" class="members-scroll-area" style="flex-grow: 1; overflow-y: auto;">
                        <!-- JS rellenar√° esto -->
                        <p style="text-align: center; color: #666;">Cargando efectivos...</p>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- ====================================================================== -->
    <!-- WIDGET DE COMUNICACI√ìN EN EL MAPA (VERSI√ìN BURBUJA CORREGIDA) -->
    <!-- ====================================================================== -->
    
    <!-- WIDGET DE CHAT (VERSI√ìN MICRO - 320px Friendly) -->
    <div id="globalChatWidget" class="chat-widget-container minimized" 
        style="position: fixed; top: 45px !important; left: 5px !important; z-index: 20000; font-family: sans-serif;">
        
        <!-- ESTADO 1: BURBUJA (30px) -->
        <div id="chatBubbleIcon" 
            style="width: 30px; height: 30px; background: rgba(0,0,0,0.8); border: 1px solid #00f3ff; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.5);">
            üí¨
        </div>
        
        <!-- ESTADO 2: VENTANA (Micro) -->
        <div id="chatWindowContent" 
            style="display: none; width: 180px; height: 160px; background: rgba(10, 15, 20, 0.95); border: 1px solid #00f3ff; border-radius: 6px; flex-direction: column; overflow: hidden;">
            
            <!-- Cabecera Ultra-Fina -->
            <div class="chat-header-mini" 
                style="height: 20px; background: rgba(0,243,255,0.1); display: flex; align-items: center; justify-content: space-between; padding: 0 5px; border-bottom: 1px solid #333;">
                <span style="font-size: 10px; font-weight: bold; color: #00f3ff; text-transform: uppercase;">Aliados</span>
                <button id="minimizeChatBtn" style="background: none; border: none; color: #aaa; font-size: 10px; padding: 0; cursor: pointer;">‚ñº</button>
            </div>
            
            <!-- √Årea de Mensajes (Sin texto 'Conectando') -->
            <div id="miniChatMessages" class="mini-chat-content" 
                style="flex: 1; overflow-y: auto; padding: 4px; display: flex; flex-direction: column; gap: 3px;">
                <!-- Vac√≠o por defecto para ahorrar espacio -->
            </div>
            
            <!-- Input Compacto -->
            <div class="mini-chat-input-area" style="height: 24px; display: flex; border-top: 1px solid #333; background: #000;">
                <input type="text" id="miniChatInput" placeholder="..." 
                    style="flex: 1; background: transparent; border: none; color: white; font-size: 10px; padding: 0 5px; outline: none;">
                <button id="miniChatSendBtn" 
                        style="width: 24px; background: #007bff; border: none; color: white; font-size: 10px; cursor: pointer;">‚û§</button>
            </div>
        </div>
    </div>

    <!-- ====================================================================== -->
    <!-- ======================= LANDING PAGE / WEB INFO ====================== -->
    <!-- ====================================================================== -->
    <div id="landingPageModal" class="modal" style="display: none; z-index: 20000; background: #0b0f19;">
        <div class="landing-content">
            
            <!-- Bot√≥n cerrar (Solo visible si vienes desde el Perfil) -->
            <button id="closeLandingBtn" class="close-button-landing">√ó</button>

            <!-- HERO SECTION -->
            <div class="landing-hero">
                <h1 class="landing-title">IBERION</h1>
                <p class="landing-subtitle">HEX GENERAL</p>
                <div class="landing-separator"></div>
                <p class="landing-slogan">"Donde la log√≠stica gana guerras"</p>
                
                <button id="landingEnterGameBtn" class="landing-cta-btn">ENTRAR AL JUEGO</button>
            </div>

            <!-- FEATURES GRID -->
            <div class="landing-features">
                <div class="feature-card">
                    <div class="feat-icon">‚õìÔ∏è</div>
                    <h3>Log√≠stica Brutal</h3>
                    <p>Un ej√©rcito sin comida muere. Mant√©n tus l√≠neas de suministro conectadas a la capital o tus tropas perder√°n moral y salud.</p>
                </div>

                <div class="feature-card">
                    <div class="feat-icon">üß†</div>
                    <h3>Asedio y Moral</h3>
                    <p>No basta con golpear. Rodea al enemigo, corta su retirada y observa c√≥mo su moral colapsa hasta la rendici√≥n.</p>
                </div>

                <div class="feature-card">
                    <div class="feat-icon">üéñÔ∏è</div>
                    <h3>H√©roes y Leyendas</h3>
                    <p>Recluta comandantes hist√≥ricos y forja equipo legendario. Cada general cambia las reglas del combate.</p>
                </div>

                <div class="feature-card">
                    <div class="feat-icon">‚öñÔ∏è</div>
                    <h3>Econom√≠a Viva</h3>
                    <p>Comercia con La Banca, explora ruinas antiguas y gestiona la estabilidad de tus territorios conquistados.</p>
                </div>
            </div>

            <!-- FOOTER -->
            <div class="landing-footer">
                <p>Estrategia T√°ctica por Turnos | v1.0</p>
                <div class="social-links">
                    <span>Discord</span> ‚Ä¢ <span>Twitter</span> ‚Ä¢ <span>Wiki</span>
                </div>
            </div>
        </div>
    </div>

    <!-- ====================================================================== -->
    <!-- ===================== CARGA DE SCRIPTS ===================== -->
    <!-- ====================================================================== -->
    
    <!-- === SISTEMAS CORE - Deben cargarse PRIMERO === -->
    <script src="logger.js"></script>
    <script src="eventManager.js"></script>
    <script src="intervalManager.js"></script>
    <script src="coordValidator.js"></script>
    <script src="pathCache.js"></script>
    <script src="unitGrid.js"></script>
    
    <!-- === LIBRER√çAS EXTERNAS === -->
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- === CONFIGURACI√ìN Y DATOS === -->
    <script src="supabaseConfig.js"></script>
    
    <script src="commanders.js"></script>
    <script src="constants.js"></script>
    <script src="talents.js"></script>
    <script src="talents_sprites.js"></script>
    <script src="equipment.js?v=1738080000"></script>
    <script src="state.js?v=1738080000"></script>
    <script src="utils.js?v=1738080000"></script>
    <script src="map_generation_utils.js?v=1738080000"></script>
    <script src="rewardsConfig.js?v=1738080000"></script>
    <script src="playerDataManager.js?v=1738080000"></script>
    <script src="gachaManager.js?v=1738080000"></script>
    <script src="mailboxManager.js?v=1738080000"></script> 
    <script src="seasonsData.js?v=1738080000"></script>
    <script src="raidManager.js?v=1738080000"></script>
    <script src="allianceManager.js?v=1738080000"></script>
    <script src="BattlePassManager.js?v=1738080000"></script> 
    <script src="audioManager.js"></script>
    <script src="technologyTree.js"></script> 
    <script src="worldMapData.js"></script>
    <script src="debug_functions.js"></script> <!-- Funciones de debug para pruebas -->

    <!-- === ARCHIVOS DE JUEGO (Mapas y Escenarios Est√°ndar) === -->
    <script src="maps/tactical_britain_coast_map.js"></script>
    <script src="scenarios/tutorial_scenario.js"></script>
    <script src="scenarios/britain_defense_scenario.js"></script>
    <script src="maps/iberia_map_data.js"></script>
    
    <!-- === ARCHIVOS DE PRUEBA DE IA (NUESTROS NUEVOS MAPAS) === -->
    <script src="maps/map_test_A1_SplitExpansion.js"></script>
    <script src="maps/map_test_B1_FavorableCombat.js"></script>
    <script src="maps/map_test_B2_TacticalRetreat.js"></script>
    <script src="maps/map_test_B3_SplitAndHarass.js"></script>
    <script src="maps/map_test_C1_MergeToAttack.js"></script>
    
    <!-- === ARCHIVOS DE PRUEBA DE IA (NUESTROS NUEVOS ESCENARIOS) === -->
    <script src="scenarios/test_A1_SplitExpansion_scenario.js"></script>
    <script src="scenarios/test_B1_FavorableCombat_scenario.js"></script>
    <script src="scenarios/test_B2_TacticalRetreat_scenario.js"></script>
    <script src="scenarios/test_B3_SplitAndHarass_scenario.js"></script>
    <script src="scenarios/test_C1_MergeToAttack_scenario.js"></script>
    
    <!-- === L√ìGICA PRINCIPAL DEL JUEGO (orden existente) === -->
    <script src="version.js"></script>
    <script src="adManager.js"></script>
    <script src="storeManager.js"></script>
    <script src="domElements.js"></script> 
    <script src="chronicle.js"></script> 
    <script src="cheats.js"></script> 
    <script src="debugConsole.js"></script>
    <script src="gameFlow.js?v=1738520000"></script>  
    <script src="turnTimer.js"></script>     
    <script src="uiUpdates.js?v=1738520000"></script>
    
    <script src="tutorialScripts.js"></script>
    <script src="tutorialManager.js"></script>
    <script src="boardManager.js?v=1737844900"></script>
    
    <script src="modalLogic.js"></script>
    <script src="specialUnitsLogic.js"></script>
    <script src="unit_Actions.js?v=1737844900"></script>
    <script src="autoMoveManager.js"></script>
    <script src="autoResearchManager.js"></script>
    <script src="researchRewardsManager.js"></script>
    <script src="techScreenUI.js?v=1738082200"></script>
    <script src="networkManager.js"></script> 
    <script src="ai_deploymentLogic.js"></script>
    <script src="ai_gameplayLogic.js?v=5"></script>
    <script src="ai_enhanced_functions.js"></script>
    <script src="ia_archipielago/IA_SENTIDOS.js"></script>
    <script src="ia_archipielago/IA_ECONOMICA.js"></script>
    <script src="ia_archipielago/IA_TACTICA.js"></script>
    <script src="ia_archipielago/IA_ARCHIPIELAGO.js"></script>
    <script src="bank_logic.js"></script>
    <script src="saveLoad.js"></script>
    <script src="campaignManager.js"></script>
    <script src="inventoryLogic.js"></script>
    
    <!-- NUEVOS SCRIPTS: SISTEMA DE REPLAY/CR√ìNICAS -->
    <script src="replayEngine.js"></script>
    <script src="replayRenderer.js"></script>
    <script src="replayUI.js"></script>
    <script src="replayStorage.js"></script>
    <script src="replayIntegration.js"></script>
    <script src="replayApi.js"></script>

    <!-- NUEVOS SCRIPTS: CUADERNO DE ESTADO Y CR√ìNICA -->
    <script src="statTracker.js"></script>
    <script src="ledgerManager.js"></script>
    <script src="ledgerUI.js"></script>
    <script src="ledgerButtonIntegration.js"></script>
    <script src="ledgerIntegration.js"></script>
    <script src="chronicleIntegration.js"></script>
    <script src="legacyManager.js"></script>
    <script src="legacyUI.js"></script>
    <script src="gameHistoryManager.js"></script>
    <script src="gameHistoryUI.js"></script>
    <!-- <script src="gameHistoryButtonIntegration.js"></script> --> <!-- DESHABILITADO: El historial ahora se accede v√≠a "C√≥dice de Batallas" -->
    
    <script src="main.js?v=1738520000"></script>
    
    <!-- SCRIPTS DE TESTING -->
    <script src="test-replay-system-comprehensive.js"></script>
    
    <!-- MODAL DE REPLAY -->
    <div id="replayModal" class="modal" style="display: none; background: rgba(0,0,0,0.95); z-index: 10000;">
        <div style="
            width: 95vw;
            height: 95vh;
            background: #1a252f;
            border: 2px solid #00f3ff;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            position: relative;
            box-shadow: 0 0 20px rgba(0,243,255,0.3);
        ">
            <!-- ENCABEZADO -->
            <div style="
                background: linear-gradient(90deg, #0a1929, #1a3a4a);
                border-bottom: 2px solid #00f3ff;
                padding: 15px 20px;
                display: flex;
                justify-content: space-between;
                align-items: center;
            ">
                <h2 id="replayTitle" style="color: #00f3ff; margin: 0; flex: 1;">
                    CR√ìNICA DE BATALLA
                </h2>
                <button onclick="ReplayUI.closeReplayModal()" style="
                    background: #e74c3c;
                    color: white;
                    border: none;
                    padding: 8px 16px;
                    border-radius: 4px;
                    cursor: pointer;
                    font-weight: bold;
                ">‚úï CERRAR</button>
            </div>

            <!-- CONTENEDOR PRINCIPAL (2 columnas) -->
            <div style="
                display: flex;
                flex: 1;
                gap: 10px;
                overflow: hidden;
                padding: 10px;
            ">
                <!-- COLUMNA IZQUIERDA: Log de Eventos -->
                <div style="
                    width: 25%;
                    background: #0a1929;
                    border: 1px solid #00f3ff;
                    border-radius: 4px;
                    padding: 10px;
                    overflow-y: auto;
                    color: #aaa;
                ">
                    <h4 style="color: #00f3ff; margin-top: 0;">üìú EVENTOS</h4>
                    <div id="replayEventLog" style="font-size: 0.85em;">
                        <!-- Llenado din√°micamente -->
                    </div>
                </div>

                <!-- COLUMNA CENTRAL: Canvas de Replay -->
                <div style="
                    flex: 1;
                    background: #0a1929;
                    border: 1px solid #00f3ff;
                    border-radius: 4px;
                    position: relative;
                    overflow: hidden;
                ">
                    <canvas id="replayCanvas" width="800" height="600" style="
                        width: 100%;
                        height: 100%;
                        display: block;
                        background: #000;
                    "></canvas>
                </div>

                <!-- COLUMNA DERECHA: Controles -->
                <div style="
                    width: 20%;
                    background: #0a1929;
                    border: 1px solid #00f3ff;
                    border-radius: 4px;
                    padding: 15px;
                    display: flex;
                    flex-direction: column;
                    gap: 15px;
                    overflow-y: auto;
                ">
                    <h4 style="color: #00f3ff; margin: 0;">‚öôÔ∏è CONTROLES</h4>

                    <!-- Botones de reproducci√≥n -->
                    <div style="display: flex; gap: 5px;">
                        <button id="replayPrevTurnBtn" style="
                            flex: 1;
                            background: #4a7a9f;
                            color: white;
                            border: none;
                            padding: 8px;
                            border-radius: 4px;
                            cursor: pointer;
                            font-weight: bold;
                        ">‚èÆ PREV</button>
                        <button id="replayPlayBtn" style="
                            flex: 2;
                            background: #2ecc71;
                            color: white;
                            border: none;
                            padding: 8px;
                            border-radius: 4px;
                            cursor: pointer;
                            font-weight: bold;
                        ">‚ñ∂Ô∏è PLAY</button>
                        <button id="replayStopBtn" style="
                            flex: 1;
                            background: #e74c3c;
                            color: white;
                            border: none;
                            padding: 8px;
                            border-radius: 4px;
                            cursor: pointer;
                            font-weight: bold;
                        ">‚èπ STOP</button>
                        <button id="replayNextTurnBtn" style="
                            flex: 1;
                            background: #4a7a9f;
                            color: white;
                            border: none;
                            padding: 8px;
                            border-radius: 4px;
                            cursor: pointer;
                            font-weight: bold;
                        ">‚è≠ NEXT</button>
                    </div>

                    <!-- Controles de velocidad -->
                    <div>
                        <small style="color: #888;">Velocidad:</small>
                        <div style="display: flex; gap: 5px; margin-top: 5px;">
                            <button class="replay-speed-btn active" data-speed="1" style="
                                flex: 1;
                                background: #00f3ff;
                                color: #000;
                                border: none;
                                padding: 8px;
                                border-radius: 4px;
                                cursor: pointer;
                                font-weight: bold;
                            ">1x</button>
                            <button class="replay-speed-btn" data-speed="2" style="
                                flex: 1;
                                background: #4a7a9f;
                                color: white;
                                border: none;
                                padding: 8px;
                                border-radius: 4px;
                                cursor: pointer;
                                font-weight: bold;
                            ">2x</button>
                            <button class="replay-speed-btn" data-speed="4" style="
                                flex: 1;
                                background: #4a7a9f;
                                color: white;
                                border: none;
                                padding: 8px;
                                border-radius: 4px;
                                cursor: pointer;
                                font-weight: bold;
                            ">4x</button>
                        </div>
                    </div>

                    <!-- Timeline scrubber -->
                    <div>
                        <small style="color: #888;">Timeline:</small>
                        <input id="replayTimeline" type="range" min="0" max="100" value="0" style="
                            width: 100%;
                            margin-top: 5px;
                        ">
                        <div id="replayTurnDisplay" style="
                            text-align: center;
                            color: #00f3ff;
                            font-size: 0.9em;
                            margin-top: 5px;
                        ">T0/0</div>
                    </div>

                    <!-- Bot√≥n de compartir -->
                    <button onclick="ReplayUI.generateShareLink()" style="
                        background: #f39c12;
                        color: white;
                        border: none;
                        padding: 10px;
                        border-radius: 4px;
                        cursor: pointer;
                        font-weight: bold;
                        width: 100%;
                    ">üîó COPIAR ENLACE</button>

                    <!-- Info del replay -->
                    <div style="
                        background: #1a3a4a;
                        border: 1px solid #00f3ff;
                        padding: 10px;
                        border-radius: 4px;
                        font-size: 0.85em;
                        color: #aaa;
                    ">
                        <p style="margin: 0 0 5px 0;"><strong>Info de Partida:</strong></p>
                        <div id="replayInfo">
                            <!-- Llenado din√°micamente -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- FOOTER: Barra de informaci√≥n -->
            <div style="
                background: #0a1929;
                border-top: 1px solid #00f3ff;
                padding: 10px 15px;
                font-size: 0.85em;
                color: #888;
                display: flex;
                justify-content: space-between;
                align-items: center;
            ">
                <div>
                    <span id="replayDuration">Duraci√≥n: --</span> | 
                    <span id="replayPlayers">Jugadores: --</span>
                </div>
                <div style="color: #00f3ff;">Sistema de Cr√≥nicas v1.0</div>
            </div>
        </div>
    </div>

    <style>
        .replay-turn-block {
            margin-bottom: 10px;
            padding: 8px;
            border-left: 3px solid #00f3ff;
            background: rgba(0, 243, 255, 0.05);
        }

        .replay-event {
            font-size: 0.8em;
            color: #aaa;
            margin-left: 10px;
            margin-top: 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .replay-speed-btn.active {
            background: #00f3ff !important;
            color: #000 !important;
        }
    </style>
    
    <!-- Actualizar marca de agua con versi√≥n din√°mica -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const versionDisplay = document.getElementById('version-display');
            if (versionDisplay && window.VERSION_CONFIG) {
                versionDisplay.textContent = 'v' + VERSION_CONFIG.get();
            }
        });
    </script>
    
    <!-- Men√∫ Radial Din√°mico -->
    <div id="radialMenuContainer"></div>

    <!-- MODAL DEL CUADERNO DE ESTADO -->
    <div id="ledgerModal" class="modal" style="display: none; position: fixed; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 9999; justify-content: center; align-items: center;">
        <div style="
            width: 95vw;
            height: 95vh;
            background: linear-gradient(135deg, #1a252f, #0f1a27);
            border: 2px solid #00f3ff;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            position: relative;
            box-shadow: 0 0 20px rgba(0,243,255,0.3);
        ">
            <div style="
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 20px;
                border-bottom: 1px solid #00f3ff;
            ">
                <h2 style="color: #00f3ff; margin: 0; text-shadow: 0 0 10px #00f3ff;">üìñ CUADERNO DE ESTADO</h2>
                <button class="ledger-close" style="
                    background: none;
                    border: none;
                    color: #00f3ff;
                    font-size: 24px;
                    cursor: pointer;
                ">‚úï</button>
            </div>

            <!-- Pesta√±as -->
            <div style="
                display: flex;
                gap: 10px;
                padding: 15px 20px;
                border-bottom: 1px solid #333;
                background: rgba(0,0,0,0.3);
            ">
                <button data-tab="resumen" class="active ledger-tab" style="
                    padding: 10px 20px;
                    background: #00f3ff;
                    color: #000;
                    border: none;
                    border-radius: 4px;
                    cursor: pointer;
                    font-weight: bold;
                    transition: all 0.2s;
                ">üìä Resumen Nacional</button>
                <button data-tab="demografia" class="ledger-tab" style="
                    padding: 10px 20px;
                    background: transparent;
                    color: #00f3ff;
                    border: 1px solid #00f3ff;
                    border-radius: 4px;
                    cursor: pointer;
                    transition: all 0.2s;
                ">üìà Demograf√≠a</button>
                <button data-tab="militar" class="ledger-tab" style="
                    padding: 10px 20px;
                    background: transparent;
                    color: #00f3ff;
                    border: 1px solid #00f3ff;
                    border-radius: 4px;
                    cursor: pointer;
                    transition: all 0.2s;
                ">‚öîÔ∏è Militar</button>
                <button data-tab="economia" class="ledger-tab" style="
                    padding: 10px 20px;
                    background: transparent;
                    color: #00f3ff;
                    border: 1px solid #00f3ff;
                    border-radius: 4px;
                    cursor: pointer;
                    transition: all 0.2s;
                ">üí∞ Econom√≠a</button>
                <button data-tab="cronica" class="ledger-tab" style="
                    padding: 10px 20px;
                    background: transparent;
                    color: #00f3ff;
                    border: 1px solid #00f3ff;
                    border-radius: 4px;
                    cursor: pointer;
                    transition: all 0.2s;
                ">üìú Cr√≥nica</button>
            </div>

            <!-- Contenido -->
            <div style="
                flex: 1;
                overflow-y: auto;
                padding: 20px;
                color: #fff;
            ">
                <div data-content="resumen" style="display: block;"></div>
                <div data-content="demografia" style="display: none;"></div>
                <div data-content="militar" style="display: none;"></div>
                <div data-content="economia" style="display: none;"></div>
                <div data-content="cronica" style="display: none;"></div>
            </div>
        </div>
    </div>

    <!-- MODAL DE LA CR√ìNICA (End Game Analysis) -->
    <div id="legacyModal" class="modal" style="display: none; background: rgba(0,0,0,0.95); z-index: 9998;">
        <div style="
            width: 95vw;
            height: 95vh;
            background: linear-gradient(135deg, #2a1a0f, #1a0f05);
            border: 3px solid #d4a574;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            position: relative;
            box-shadow: 0 0 30px rgba(212,165,116,0.4);
        ">
            <div style="
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 20px;
                border-bottom: 2px solid #d4a574;
                background: linear-gradient(135deg, rgba(212,165,116,0.1), transparent);
            ">
                <h2 style="color: #d4a574; margin: 0; text-shadow: 0 0 15px #d4a574; font-family: Georgia, serif;">üëë LA CR√ìNICA DEL IMPERIO üëë</h2>
                <button class="legacy-close" style="
                    background: none;
                    border: none;
                    color: #d4a574;
                    font-size: 24px;
                    cursor: pointer;
                ">‚úï</button>
            </div>

            <!-- Pesta√±as -->
            <div style="
                display: flex;
                gap: 10px;
                padding: 15px 20px;
                border-bottom: 1px solid #444;
                background: rgba(0,0,0,0.5);
                flex-wrap: wrap;
            ">
                <button data-legacy-tab="timeline" class="active" style="
                    padding: 10px 20px;
                    background: #d4a574;
                    color: #2a1a0f;
                    border: none;
                    border-radius: 4px;
                    cursor: pointer;
                    font-weight: bold;
                    transition: all 0.2s;
                ">üìà L√≠nea de Tiempo</button>
                <button data-legacy-tab="heatmap" style="
                    padding: 10px 20px;
                    background: transparent;
                    color: #d4a574;
                    border: 1px solid #d4a574;
                    border-radius: 4px;
                    cursor: pointer;
                    transition: all 0.2s;
                ">üó∫Ô∏è Mapa de Expansi√≥n</button>
                <button data-legacy-tab="narrative" style="
                    padding: 10px 20px;
                    background: transparent;
                    color: #d4a574;
                    border: 1px solid #d4a574;
                    border-radius: 4px;
                    cursor: pointer;
                    transition: all 0.2s;
                ">üìñ Cr√≥nica Narrativa</button>
                <button data-legacy-tab="combat" style="
                    padding: 10px 20px;
                    background: transparent;
                    color: #d4a574;
                    border: 1px solid #d4a574;
                    border-radius: 4px;
                    cursor: pointer;
                    transition: all 0.2s;
                ">‚öîÔ∏è An√°lisis de Combate</button>
            </div>

            <!-- Contenido -->
            <div style="
                flex: 1;
                overflow-y: auto;
                padding: 20px;
                color: #e8dcc0;
                font-family: Georgia, serif;
            ">
                <div data-legacy-content="timeline" style="display: block;"></div>
                <div data-legacy-content="heatmap" style="display: none;"></div>
                <div data-legacy-content="narrative" style="display: none;"></div>
                <div data-legacy-content="combat" style="display: none;"></div>
            </div>
        </div>
    </div>

    <!-- ESTILOS PARA CUADERNO Y CR√ìNICA -->
    <style>
        .ledger-section {
            margin-bottom: 30px;
            padding: 15px;
            background: rgba(0,243,255,0.05);
            border-left: 3px solid #00f3ff;
            border-radius: 4px;
        }

        .ledger-section h3 {
            color: #00f3ff;
            margin-top: 0;
            text-shadow: 0 0 5px #00f3ff;
        }

        .ledger-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }

        .ledger-card {
            background: rgba(255,255,255,0.05);
            border: 1px solid #00f3ff;
            border-radius: 4px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            text-align: center;
        }

        .ledger-card.full-width {
            grid-column: 1 / -1;
        }

        .ledger-card .label {
            font-size: 0.9em;
            color: #aaa;
        }

        .ledger-card .value {
            font-size: 1.3em;
            font-weight: bold;
            color: #00f3ff;
        }

        .ledger-card .value.income {
            color: #4caf50;
        }

        .ledger-card .value.expense {
            color: #f44336;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: rgba(0,0,0,0.3);
            border-radius: 3px;
            overflow: hidden;
            margin: 5px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4caf50, #00f3ff);
            transition: width 0.3s;
        }

        .progress-mini {
            height: 4px;
            background: #4caf50;
            border-radius: 2px;
            display: inline-block;
        }

        .ledger-table-container {
            overflow-x: auto;
            border: 1px solid #00f3ff;
            border-radius: 4px;
        }

        .ledger-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }

        .ledger-table th {
            background: rgba(0,243,255,0.2);
            color: #00f3ff;
            padding: 12px;
            text-align: left;
            font-weight: bold;
            border-bottom: 1px solid #00f3ff;
        }

        .ledger-table td {
            padding: 10px;
            border-bottom: 1px solid #333;
            color: #ddd;
        }

        .ledger-table tr:hover {
            background: rgba(0,243,255,0.1);
        }

        .ledger-table tr.highlight-row {
            background: rgba(76,175,80,0.1);
            font-weight: bold;
        }

        /* Estilos para Cr√≥nica */
        .narrative-log {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .narrative-entry {
            padding: 12px;
            background: rgba(212,165,116,0.1);
            border-left: 3px solid #d4a574;
            border-radius: 4px;
            display: flex;
            gap: 10px;
            align-items: flex-start;
        }

        .narrative-icon {
            font-size: 1.3em;
            min-width: 30px;
            text-align: center;
        }

        .narrative-text {
            flex: 1;
            line-height: 1.4;
        }

        .legacy-chart {
            margin: 20px 0;
        }

        .legacy-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 15px;
            padding: 10px;
            background: rgba(0,0,0,0.3);
            border-radius: 4px;
        }

        .legacy-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85em;
        }

        .legacy-table th {
            background: rgba(212,165,116,0.2);
            color: #d4a574;
            padding: 12px;
            text-align: left;
            font-weight: bold;
            border-bottom: 2px solid #d4a574;
        }

        .legacy-table td {
            padding: 10px;
            border-bottom: 1px solid #444;
            color: #e8dcc0;
        }

        .legacy-table tr:hover {
            background: rgba(212,165,116,0.1);
        }

        .heatmap-hex:hover {
            opacity: 0.8 !important;
            box-shadow: 0 0 10px rgba(255,255,255,0.3) !important;
        }

        .ledger-tab.active {
            background: #00f3ff !important;
            color: #000 !important;
        }

        [data-legacy-tab].active {
            background: #d4a574 !important;
            color: #2a1a0f !important;
        }

        /* Estilos para Historial de Partidas */
        .history-table-container {
            overflow-x: auto;
            border: 1px solid #00f3ff;
            border-radius: 4px;
            margin-top: 20px;
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.95em;
        }

        .history-table th {
            background: rgba(0,243,255,0.2);
            color: #00f3ff;
            padding: 12px;
            text-align: left;
            font-weight: bold;
            border-bottom: 1px solid #00f3ff;
        }

        .history-table td {
            padding: 12px;
            border-bottom: 1px solid #333;
            color: #ddd;
        }

        .history-table tr:hover {
            background: rgba(0,243,255,0.1);
        }

        .history-btn {
            padding: 6px 10px;
            margin: 0 2px;
            border: 1px solid #00f3ff;
            background: transparent;
            color: #00f3ff;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.2s;
        }

        .history-btn:hover {
            background: #00f3ff;
            color: #000;
        }

        .game-details {
            padding: 20px;
        }

        .game-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .info-card {
            background: rgba(0,243,255,0.1);
            border: 1px solid #00f3ff;
            border-radius: 4px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .info-card .label {
            color: #aaa;
            font-size: 0.9em;
        }

        .info-card .value {
            color: #00f3ff;
            font-size: 1.2em;
            font-weight: bold;
        }
    </style>

    <!-- MODAL DEL HISTORIAL DE PARTIDAS -->
    <div id="gameHistoryModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 10100; justify-content: center; align-items: center;">
        <div style="
            width: 90vw;
            max-width: 1000px;
            height: 80vh;
            background: linear-gradient(135deg, #1a252f, #0f1a27);
            border: 2px solid #00f3ff;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            position: relative;
            box-shadow: 0 0 20px rgba(0,243,255,0.3);
        ">
            <div style="
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 20px;
                border-bottom: 1px solid #00f3ff;
            ">
                <h2 style="color: #00f3ff; margin: 0; text-shadow: 0 0 10px #00f3ff;">üìö HISTORIAL DE PARTIDAS</h2>
                <button class="history-close" style="
                    background: none;
                    border: none;
                    color: #00f3ff;
                    font-size: 24px;
                    cursor: pointer;
                ">‚úï</button>
            </div>

            <div class="history-content" style="
                flex: 1;
                overflow-y: auto;
                padding: 20px;
                color: #fff;
            ">
                <p style="text-align: center; color: #aaa;">Cargando...</p>
            </div>
        </div>
    </div>

    <script src="test-replay-system.js"></script>

</body>
</html>