1. DURANTE LA PARTIDA: "El Cuaderno de Estado" (The Ledger)
E "Ledger" es una biblia de estad√≠sticas. un Modal con Pesta√±as accesible desde la UI principal.
A. Pesta√±a: RESUMEN NACIONAL (El "Outliner")
Una vista r√°pida del estado de tu imperio.
‚Ä¢	Tesorer√≠a: +Ingresos vs -Gastos (Mantenimiento de tropas). Balance neto por turno.
‚Ä¢	Capacidad Militar: Regimientos Activos / L√≠mite de Suministros (basado en tu infraestructura: Metr√≥polis, Fortalezas).
‚Ä¢	Estabilidad: Nivel de corrupci√≥n (si no hay caminos) vs Orden p√∫blico.
‚Ä¢	Recursos Estrat√©gicos: Stock actual y +/- producci√≥n por turno de Hierro, Madera, Comida, Piedra.
B. Pesta√±a: DEMOGRAF√çA (Comparativa - Estilo Civ4)
Aqu√≠ es donde el jugador ve qu√© tan bien lo est√° haciendo comparado con el resto, sin romper la niebla de guerra (muestra rangos o promedios si no tienes espionaje).
‚Ä¢	Tabla de Rangos:
o	Poblaci√≥n: (Suma de niveles de ciudad).
o	Fuerza Industrial: (Capacidad de producci√≥n de recursos).
o	Poder Militar: (Valor calculado de Ataque + Defensa de todas las unidades). El famoso "Soldiers" de Civ4.
o	Territorio: (Hex√°gonos controlados).
‚Ä¢	Visual: Tu posici√≥n debe resaltar (ej. "3¬∫ de 8").
C. Pesta√±a: MILITAR (Desglose T√°ctico)
Vital para tu distinci√≥n entre Naval y Tierra.
‚Ä¢	Ej√©rcito de Tierra: Lista de divisiones, su moral promedio y su ubicaci√≥n.
o	Columna extra: Estado de Suministros (si est√°n en reserva recuper√°ndose).
‚Ä¢	Armada Real: Lista de flotas.
o	Dato clave: Valor de Maniobra (Promedio para el Barlovento).
o	Dato clave: Cantidad de Pataches vs Buques de Guerra.
‚Ä¢	Manpower (Reclutas): Cu√°ntos soldados reales quedan en la reserva para reponer bajas.
D. Pesta√±a: ECONOM√çA (Libro de Cuentas)
Desglose del Oro.
‚Ä¢	Ingresos: Impuestos de ciudades + Comercio (Caravanas) + Saqueos + Tratados.
‚Ä¢	Gastos: Mantenimiento de Edificios + Mantenimiento de Ej√©rcito (Upkeep) + Corrupci√≥n.
‚Ä¢	Gr√°fico circular: ¬øEn qu√© se me va el dinero?
________________________________________
2. FIN DE PARTIDA / PAUSA: "La Cr√≥nica" (The Legacy)
Aqu√≠ es donde Civilization IV brilla con sus gr√°ficos y l√≠neas de tiempo. Esto genera la sensaci√≥n de "viaje √©pico".
A. LA L√çNEA DE TIEMPO (El Gr√°fico XY)
Un gr√°fico lineal con el Turno en el eje X y valores en el eje Y. Debe permitir cambiar el filtro:
‚Ä¢	Puntuaci√≥n Total.
‚Ä¢	Poder Militar (Ver√°s cu√°ndo ocurrieron las grandes guerras: picos y ca√≠das bruscas).
‚Ä¢	Econom√≠a (Oro Acumulado).
‚Ä¢	Mec√°nica: Debes poder ver las l√≠neas de los rivales (ahora reveladas) para saber en qu√© turno te superaron.
B. EL MAPA DE CALOR (Replay Visual)
Un mapa simplificado del mundo que se reproduce autom√°ticamente (Timelapse).
‚Ä¢	Los colores de cada jugador se expanden como manchas de aceite sobre los hex√°gonos.
‚Ä¢	Las batallas importantes aparecen como "chispas" o iconos de espadas cruzadas que desaparecen r√°pido.
‚Ä¢	Se ve c√≥mo la "Caravana Imperial" avanz√≥ y d√≥nde fue detenida.
C. LA CR√ìNICA ESCRITA (Log Narrativo - Estilo EU4)
Como mencionaste, un log detallado, pero convertido en historia.
‚Ä¢	Turno 1: "La Casa de [Jugador] fue fundada en la costa."
‚Ä¢	Turno 12: "Comenz√≥ la Edad de Hierro tras descubrir la forja."
‚Ä¢	Turno 24: "Gran Batalla Naval en el Cabo de la Esperanza. La flota de [Jugador] hundi√≥ 3 nav√≠os enemigos gracias al Barlovento."
‚Ä¢	Turno 40: "Victoria por Dominaci√≥n."
D. AN√ÅLISIS DE COMBATE (El "Combat Log" Detallado)
Este es el apartado t√©cnico para jugadores 'hardcore' que quieren entender por qu√© perdieron. Una tabla con las √∫ltimas 10 batallas:
‚Ä¢	Atacante vs Defensor.
‚Ä¢	Terreno: (Bonificador % usado).
‚Ä¢	Tiradas: Mostrar los dados (Suerte) + Bonos de H√©roe + Bonos de Tecnolog√≠a.
‚Ä¢	Resultado: Bajas exactas de cada bando (Ej: Perdiste 400 infanter√≠a, Enemigo perdi√≥ 120 caballer√≠a).
________________________________________
3. DISE√ëO VISUAL (UI) RECOMENDADO
Para que se sienta "Premium" como Civ o EU, evita las tablas de Excel crudas.
1.	Iconograf√≠a: Usa iconos peque√±os al lado de los textos (una espada para militar, una moneda para econom√≠a).
2.	Barras de Progreso: En lugar de solo decir "Salud: 80%", pon una barra verde.
3.	Color Coding:
o	Verde: Ingresos, Victorias, Territorio ganado.
o	Rojo: Gastos, Derrotas, Unidades perdidas.
o	Dorado: Eventos especiales, Maravillas/Metr√≥polis construidas.
4.	Tooltips (Informaci√≥n Flotante):
o	Si tocas un valor en la tabla (ej. "Ataque: 180"), debe salir un peque√±o bocadillo explicando la suma: Base (100) + H√©roe (50) + Terreno (30). Esto es fundamental en Civ4 para entender las reglas.
Ejemplo de Estructura de Tabla (Resumen de Partida)
Rango	Bandera	Jugador	Puntuaci√≥n	‚öîÔ∏è Militar	üí∞ Oro	‚öì Flota	Ciudades
ü•á	üá™üá∏	T√∫	4,500	120k	5,000	Supremac√≠a	8
ü•à	ü§ñ	IA Roma	3,200	140k	1,200	D√©bil	12
ü•â	üá´üá∑	Human2	1,100	20k	800	Media	4
Esta estructura da satisfacci√≥n inmediata: "¬øGan√©? S√≠. ¬øPor qu√©? Porque mi flota (Supremac√≠a) compens√≥ que la IA ten√≠a m√°s ej√©rcito de tierra".

________________________________________
4. ESTADO ACTUAL DE IMPLEMENTACI√ìN (Feb 2026)
________________________________________

üìã INVENTARIO DE SISTEMAS EXISTENTES
A. EL CUADERNO DE ESTADO (LEDGER) - ‚úÖ INTERFAZ COMPLETA, ‚ö†Ô∏è L√ìGICA PARCIAL
‚Ä¢	ledgerManager.js: ‚úÖ M√©todos para 4 pesta√±as (Resumen, Demograf√≠a, Militar, Econom√≠a)
‚Ä¢	ledgerUI.js: ‚úÖ Interfaz visual completa con dise√±o premium
‚Ä¢	ledgerIntegration.js: ‚úÖ Hook para abrir desde consola
‚Ä¢	index.html l√≠nea 2120: ‚úÖ Modal #ledgerModal totalmente implementado
‚Ä¢	Estado: FUNCIONAL pero falta conectar con StatTracker para datos en vivo

B. LA CR√ìNICA (CHRONICLE) - ‚úÖ FUNCIONAL, SOLO LOGS B√ÅSICOS
‚Ä¢	chronicle.js: ‚úÖ Sistema narrativo con generateMessage() implementado
‚Ä¢	currentMatchLogs[]: ‚úÖ Array para almacenar eventos de la partida
‚Ä¢	Integraci√≥n: ‚ö†Ô∏è Solo eventos b√°sicos (move, conquest, battle_start, unit_destroyed)
‚Ä¢	Estado: FUNCIONAL pero limitado. Falta expansi√≥n de tipos de eventos.

C. SISTEMA DE REPLAY - ‚ö†Ô∏è IMPLEMENTADO PERO CON ERRORES
‚Ä¢	replayEngine.js: ‚úÖ Motor de captura completo (191 l√≠neas)
‚Ä¢	replayStorage.js: ‚ö†Ô∏è Guardado en Supabase con ERROR 22001 (campo VARCHAR(255) insuficiente)
‚Ä¢	replayIntegration.js: ‚úÖ Hooks no invasivos en gameFlow
‚Ä¢	replayUI.js: ‚úÖ Interfaz visual
‚Ä¢	replayRenderer.js: ‚úÖ Motor de renderizado del timelapse
‚Ä¢	Integraci√≥n main.js l√≠nea 1261: ‚úÖ startGameRecording() llamado correctamente
‚Ä¢	Integraci√≥n gameFlow.js l√≠nea 1180: ‚úÖ finishGameRecording() llamado al fin de batalla

‚ùå PROBLEMA CR√çTICO DEL REPLAY:
S√≠ntoma: Error 22001 "value too long for type character varying(255)"
Causa: Campo timeline_compressed en tabla game_replays limitado a 255 bytes
Soluci√≥n: Ejecutar en Supabase SQL Editor:
  ALTER TABLE game_replays ALTER COLUMN timeline_compressed SET DATA TYPE TEXT;
  ALTER TABLE game_replays ALTER COLUMN metadata SET DATA TYPE TEXT;

D. INTEGRACI√ìN CON SISTEMA DE ESTAD√çSTICAS - ‚úÖ COMPLETO
‚Ä¢	statTracker.js: ‚úÖ EXISTE (284 l√≠neas) con seguimiento completo de:
   - Oro, territorio, ciudades, poblaci√≥n
   - Poder militar (tierra y naval)
   - Puntuaci√≥n calculada autom√°ticamente
   - Log de eventos importantes y batallas
‚Ä¢	LedgerManager l√≠nea 73: ‚úÖ Llama a StatTracker.getPlayerStats() correctamente
‚Ä¢	index.html l√≠nea 1837: ‚úÖ Script cargado correctamente
‚Ä¢	main.js l√≠nea 1266: ‚úÖ StatTracker.initialize() llamado al inicio
‚Ä¢	Estado: FUNCIONAL y conectado al Cuaderno de Estado

________________________________________
5. PLAN DE ACCI√ìN INMEDIATO
________________________________________

üî¥ URGENTE - ARREGLAR REPLAY (5 minutos):
1ÔøΩ VERIFICADO - StatTracker ya existe y funciona:
‚úÖ statTracker.js implementado (284 l√≠neas)
‚úÖ Integrado en main.js, ledgerManager.js
‚úÖ Captura autom√°tica de estad√≠sticas cada turno
‚úÖ M√©todos disponibles: getPlayerStats(), getRanking(), getBattleLog()
‚Üí NO REQUIERE ACCI√ìN. Sistema completo.
       militaryUnits: units.filter(u => u.owner === playerId).length,
       // ... etc
     })
   };
3. Integrar en ledgerManager.js correctamente
4. Probar apertura de Cuaderno desde consola: LedgerIntegration.openLedger()

üü¢ MEJORA - EXPANDIR CR√ìNICA (30 minutos):
1. A√±adir eventos en chronicle.js:
   - 'research_complete': Tecnolog√≠a descubierta
   - 'city_founded': Ciudad fundada
   - 'unit_recruited': Unidad reclutada
   - 'alliance_formed': Alianza formada
   - 'trade_route_established': Ruta comercial abierta
2. Integrar llamadas a Chronicle.logEvent() en:
   - researchManager.js (si existe)
   - cityBuilder.js o boardManager.js (fundaci√≥n)
   - unit_Actions.js (reclutamiento)
3. Probar que currentMatchLogs[] se llena correctamente

üü¢ PULIDO - DISE√ëO VISUAL (1 hora):
1. A√±adir estilos CSS para:
   - Barras de progreso (.progress-bar, .progress-fill)
   - Cards del ledger (.ledger-card)
   - Tablas de demograf√≠a con color coding
2. Crear iconos custom para recursos (actualmente emoji b√°sicos)
3. A√±adir tooltips explicativos en valores del Cuaderno

________________________________________
6. CHECKLIST DE FUNCIONALIDAD ESPERADA
________________________________________

‚òëÔ∏è Debe funcionar HOY (despu√©s de fix SQL):
‚úÖ Abrir Cuaderno de Estado: LedgerIntegration.openLedger()
‚úÖ Ver Resumen Nacional con datos b√°sicos
‚úÖ Ver logs narrativos en consola: [CR√ìNICA] ...
‚úÖ Guardar replay al finalizar partida (SIN error 22001)

‚òê Debe funcionar MA√ëANA (despu√©s de implementar StatTracker):
‚¨ú Ver Demograf√≠a comparativa entre jugadores
‚¨ú Ver listado de unidades militares en pesta√±a Militar
‚¨ú Ver gr√°fico de ingresos/gastos en pesta√±a Econom√≠a
‚¨ú Ver replay visual (mapa de calor con expansi√≥n territorial)

‚òëÔ∏è Debe funcionar AHORA (StatTracker ya implementado):
‚úÖ Ver Demograf√≠a comparativa entre jugadores (datos disponibles)
‚úÖ Ver listado de unidades militares en pesta√±a Militar (datos disponibles)
‚úÖ Ver ingresos/gastos en pesta√±a Econom√≠a (datos disponibles)
‚¨ú Ver replay visual (mapa de calor) - Pendiente de fix SQL 22001

________________________________________
7. COMANDOS DE DEBUGGING RECOMENDADOS
________________________________________

// Abrir Cuaderno de Estado
LedgerIntegration.openLedger()

// Ver estado del replay
console.log('Replay enabled:', ReplayEngine.isEnabled)
console.log('Events captured:', ReplayEngine.timeline.length)

// Ver logs de cr√≥nica
console.log('Chronicle logs:', Chronicle.currentMatchLogs)

// Simular evento de cr√≥nica
Chronicle.logEvent('move', { unit: units[0], toR: 5, toC: 10 })

// Forzar guardado manual de replay (al terminar partida)
ReplayIntegration.finishGameRecording(1, gameState.turnNumber)

________________________________________
CONCLUSI√ìN:
El sistema est√° 70% implementado. El bloqueador principal es el error SQL 22001 en replays.
Una vez resuelto, el Cuaderno de Estado y la Cr√≥nica son funcionales pero requieren
conexi√≥n con StatTracker y expansi√≥n de eventos para alcanzar la visi√≥n completa del dise√±o.
 (ACTUALIZADA Feb 1, 2026):
El sistema est√° 85% implementado. ‚úÖ StatTracker verificado y funcional.

üî¥ √öNICO BLOQUEADOR CR√çTICO:
Error SQL 22001 en tabla game_replays (campo VARCHAR(255) ‚Üí TEXT)
‚Üí Requiere 1 minuto para arreglar en Supabase SQL Editor

‚úÖ SISTEMAS FUNCIONALES HOY:
‚Ä¢ Cuaderno de Estado con 4 pesta√±as (UI completa + datos conectados)
‚Ä¢ Cr√≥nica narrativa (logs en consola)
‚Ä¢ StatTracker capturando estad√≠sticas en tiempo real
‚Ä¢ ReplayEngine grabando eventos (solo falla el guardado en BD)

üü° MEJORAS PENDIENTES (NO BLOQUEANTES):
‚Ä¢ Expandir tipos de eventos en Chronicle
‚Ä¢ A√±adir gr√°ficos XY en Cuaderno de Estado
‚Ä¢ Implementar mapa de calor visual en replay
‚Ä¢ A√±adir tooltips y pulido visual

üìù PR√ìXIMO PASO INMEDIATO:
1. Ejecutar SQL fix en Supabase (1 min)
2. Probar partida completa (5 min)
3. Verificar en logs: "[ReplayStorage] ‚úÖ Replay ... guardado exitosamente"
4. Abrir Cuaderno: LedgerIntegration.openLedger()
5. ‚úÖ Sistema 100% funcional